<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteador de Times - Futsal/Society</title>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #198754;
            --accent-color: #0dcaf0;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        select, textarea, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0b5ed7;
        }

        #playersList {
            margin-top: 30px;
        }

        .player-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-name {
            font-weight: 600;
            flex: 1;
        }

        .player-ratings {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 8px;
        }

        .rating-option {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .goalkeeper-checkbox {
            margin-left: 15px;
        }

        .team-naming-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team-naming-card {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .team-naming-card h4 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .team-naming-card input {
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .team-preview {
            background-color: white;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .team-preview-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .team-preview-players {
            font-size: 14px;
            color: #666;
        }

        .naming-info {
            background-color: #e7f3ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .naming-info h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .naming-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        #teamsResult {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .team-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--primary-color);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .team-rating {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-item-name {
            font-weight: 500;
        }

        .player-item-rating {
            background-color: #f0f2f5;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .goalkeeper {
            color: var(--primary-color);
            font-weight: 700;
        }

        .goalkeeper::after {
            content: " (Goleiro)";
            font-size: 0.9em;
            color: var(--primary-color);
        }

        .makeshift-goalkeeper {
            color: var(--warning-color);
            font-weight: 700;
        }

        .fake-player {
            color: var(--danger-color);
            font-style: italic;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .steps-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 15px;
            height: 15px;
            background-color: #ddd;
            border-radius: 50%;
            margin: 0 5px;
        }

        .step-dot.active {
            background-color: var(--primary-color);
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn-back {
            background-color: var(--gray-color);
        }

        .btn-next {
            background-color: var(--secondary-color);
        }

        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--danger-color);
            margin-bottom: 20px;
        }

        .modal-body {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--dark-color);
            margin-bottom: 25px;
            text-align: left;
            white-space: pre-line;
        }

        .modal-footer {
            text-align: center;
        }

        .modal-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn:hover {
            background-color: #0b5ed7;
        }

        #shareWhatsApp {
            background-color: #25D366 !important;
        }

        #shareWhatsApp:hover {
            background-color: #1da851 !important;
        }

        .rating-info {
            background-color: #e7f3ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .rating-info h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .rating-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .player-counter {
            text-align: right;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .game-header {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .match-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
        }

        .game-type-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .team-score {
            text-align: center;
        }

        .team-name-score {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 10px 20px;
            min-width: 80px;
        }

        .vs {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .timer-section {
            margin-top: 20px;
        }

        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 10px;
            display: inline-block;
            min-width: 120px;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .timer-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .timer-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .team-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .team-panel h4 {
            margin: 0 0 15px 0;
            text-align: center;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-item-game {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-goals {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        .goal-panel {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .goal-panel h4 {
            margin: 0 0 20px 0;
            font-size: 1.3rem;
        }

        .goal-controls {
            margin-bottom: 20px;
        }

        .goal-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            background: #28a745;
            color: white;
            width: 100%;
        }

        .goal-btn:hover {
            transform: scale(1.05);
            background: #218838;
        }

        .goal-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .goal-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-height: 85vh;
            overflow-y: auto;
        }

        .goal-modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .goal-modal-teams {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .goal-modal-team {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
        }

        .goal-modal-team h5 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            text-align: center;
            font-size: 1.1rem;
        }

        .goal-modal-players {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .goal-modal-player {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            text-align: center;
            font-weight: 500;
        }

        .goal-modal-player:hover {
            border-color: var(--primary-color);
            background-color: #e7f3ff;
        }

        .goal-modal-player.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .goal-modal-options {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .goal-modal-options h5 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .goal-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .goal-option label {
            font-weight: 500;
            cursor: pointer;
        }

        .assist-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .assist-section h6 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            font-size: 14px;
        }

        .assist-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .goal-modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .goal-modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .goal-modal-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }

        .goal-modal-btn.cancel:hover {
            background-color: #5a6268;
        }

        .goal-modal-btn.confirm {
            background-color: var(--secondary-color);
            color: white;
        }

        .goal-modal-btn.confirm:hover {
            background-color: #157347;
        }

        .goal-modal-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .goal-history {
            text-align: left;
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
        }

        .goal-history h5 {
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .goal-item {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .game-result {
            text-align: center;
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .final-result {
            font-size: 1.5rem;
            margin: 15px 0;
        }

        .match-summary {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .player-management {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .player-management h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            text-align: center;
        }

        .management-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-player-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .swap-players-btn {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .player-swap-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .swap-modal-content {
	    background-color: white;
	    margin: 2% auto;
	    padding: 20px;
	    border-radius: 10px;
	    width: 95%;
	    max-width: 900px;
	    max-height: 90vh;
	    overflow-y: auto;
	    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
	    position: relative;
	}

	.swap-teams-grid {
	    max-height: 70vh;
	    overflow-y: auto;
	    padding-right: 10px;
	}
	
	.swap-teams-grid::-webkit-scrollbar {
	    width: 8px;
	}
	
	.swap-teams-grid::-webkit-scrollbar-track {
	    background: #f1f1f1;
	    border-radius: 4px;
	}
	
	.swap-teams-grid::-webkit-scrollbar-thumb {
	    background: #c1c1c1;
	    border-radius: 4px;
	}
	
	.swap-teams-grid::-webkit-scrollbar-thumb:hover {
	    background: #a1a1a1;
	}

        .swap-teams {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .swap-team-section {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
        }

        .swap-player-item {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .swap-player-item:hover {
            border-color: var(--primary-color);
            background-color: #e7f3ff;
        }

        .swap-player-item.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .add-player-section {
            background-color: #e7f3ff;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .move-player-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
        }

        .move-player-btn:hover {
            background-color: #0b5ed7;
        }

        .swap-teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .team-players-count {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
        }

        .warning-text {
            color: var(--danger-color);
            font-weight: bold;
        }

        .delete-player-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin: 2px;
            transition: background-color 0.3s;
        }

        .delete-player-btn:hover {
            background-color: #c82333;
        }

        .warning-modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .warning-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .warning-modal-header {
            background: linear-gradient(135deg, var(--warning-color), #fd7e14);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #e0a800;
        }

        .warning-modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .warning-modal-body {
            padding: 25px;
            text-align: center;
        }

        .warning-teams-list {
            background-color: #fff3cd;
            border: 2px solid var(--warning-color);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .warning-team-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ffeaa7;
        }

        .warning-team-item:last-child {
            border-bottom: none;
        }

        .warning-team-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .warning-team-count {
            background-color: var(--danger-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .warning-modal-footer {
            padding: 20px 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .warning-modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .warning-continue-btn {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        .warning-continue-btn:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .warning-cancel-btn {
            background-color: var(--gray-color);
            color: white;
        }

        .warning-cancel-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        /* Firebase Auth Styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }

        .auth-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .auth-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auth-btn:hover {
            background: #0b5ed7;
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .error-message {
            background: #ffebee;
            color: var(--danger-color);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #e8f5e8;
            color: var(--secondary-color);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }

        .user-info.visible {
            display: block;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        .save-indicator.saving {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .save-indicator.error {
            background: var(--danger-color);
        }

        .main-app {
            display: none;
        }

        .main-app.visible {
            display: block;
        }

        #authSection {
            display: block;
        }

        .main-app {
            display: none;
        }

        .main-app.visible {
            display: block;
        }

        /* Fallback adicional para controle de visibilidade */
        body:has(#mainApp.visible) #authSection {
            display: none !important;
        }

        /* Classe auxiliar para browsers sem :has() */
        .hide-auth #authSection {
            display: none !important;
        }

        /* Esconder auth quando main app estiver vis√≠vel */
        /* .main-app.visible ~ #authSection {
            display: none;
        } */

        .history-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .history-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-teams {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-score {
            color: var(--secondary-color);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .history-stats {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .load-game-btn {
            background: var(--warning-color);
            color: var(--dark-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }

        .delete-history-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .team-card {
                margin-bottom: 20px;
            }
            
            .player-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .player-name {
                margin-bottom: 10px;
                font-size: 1rem;
            }
            
            .player-ratings {
                width: 100%;
                justify-content: space-between;
            }
            
            .rating-options {
                display: flex;
                gap: 10px;
            }
            
            button {
                width: 100%;
                margin-top: 5px;
            }
            
            .btn-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-back, .btn-next {
                width: 100%;
            }

            #shareWhatsApp {
                margin-bottom: 10px;
            }
            
            .teams-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .goal-panel {
                order: -1;
            }
            
            .scoreboard {
                flex-direction: column;
                gap: 15px;
            }
            
            .score {
                font-size: 2rem;
            }
            
            .timer {
                font-size: 2rem;
            }

            .team-naming-grid {
                grid-template-columns: 1fr;
            }

            .goal-modal-teams {
                grid-template-columns: 1fr;
            }

            .swap-modal-content {
                margin: 1% auto;
                width: 98%;
                max-height: 95vh;
            padding: 15px;
            }
            
            .swap-teams-grid {
            grid-template-columns: 1fr;
            max-height: 75vh;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
</head>
<body>
    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">Salvando...</div>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-container">
        <div class="auth-form">
            <div class="auth-header">
                <h2>‚öΩ Sorteador de Times</h2>
                <p>Entre para salvar seu hist√≥rico completo de jogos</p>
            </div>

            <div id="authMessage"></div>
            <div id="loadingAuth" style="display: none; text-align: center; color: var(--primary-color); font-weight: 600;">Carregando...</div>

            <!-- Login Form -->
            <form id="loginForm" style="display: block;">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">Entrar</button>
                
                <div class="auth-switch">
                    <p>N√£o tem conta? <a href="#" id="showRegister">Cadastre-se aqui</a></p>
                    <p><a href="#" id="showForgotPassword">Esqueci minha senha</a></p>
                </div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Nome:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Senha (m√≠n. 6 caracteres):</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">Confirmar Senha:</label>
                    <input type="password" id="registerPasswordConfirm" required>
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">Cadastrar</button>
                
                <div class="auth-switch">
                    <p>J√° tem conta? <a href="#" id="showLogin">Entre aqui</a></p>
                </div>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotPasswordForm" style="display: none;">
                <div class="form-group">
                    <label for="forgotEmail">Email para recupera√ß√£o:</label>
                    <input type="email" id="forgotEmail" required>
                </div>
                <button type="submit" class="auth-btn" id="forgotBtn">Enviar Link de Recupera√ß√£o</button>
                
                <div class="auth-switch">
                    <p><a href="#" id="backToLogin">Voltar ao login</a></p>
                </div>
            </form>
        </div>
    </div>
    <div id="mainApp" class="main-app">
        <div class="container">
            <header style="position: relative;">
                <div class="user-info" id="userInfo">
                    <span id="userName">Usu√°rio</span>
                    <button class="logout-btn" id="logoutBtn">Sair</button>
                </div>
                <h1>Sorteador de Times</h1>
                <div class="subtitle">Futsal & Society</div>
            </header>

            <!-- Game History Section -->
            <div id="historySection" class="history-section" style="display: none;">
                <div class="history-header">
                    <h3>üìä Hist√≥rico Completo de Jogos</h3>
                    <button id="toggleHistory" style="background: var(--gray-color); padding: 8px 15px; font-size: 14px;">
                        Mostrar Hist√≥rico
                    </button>
                    <button id="verUsoFirebase" style="background: var(--info-color); padding: 8px 15px; font-size: 14px; margin-left: 10px;">
                        üìä Ver Uso Firebase
                    </button>
                </div>
                <div id="historyList" style="display: none;">
                    <div id="historyItems"></div>
                </div>
            </div>

            <div class="steps-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
                <div class="step-dot" data-step="5"></div>
            </div>

            <!-- Step 1: Configura√ß√µes -->
            <div class="step active" id="step1">
                <div class="card">
                    <h2>Configura√ß√µes</h2>
                    <div class="form-group">
                        <label for="gameType">Tipo de Jogo:</label>
                        <select id="gameType">
                            <option value="futsal">Futsal (5 jogadores por time)</option>
                            <option value="society">Society (Escolher n√∫mero de jogadores)</option>
                        </select>
                    </div>

                    <div class="form-group" id="societyPlayersContainer" style="display: none;">
                        <label for="societyPlayers">N√∫mero de jogadores por time:</label>
                        <select id="societyPlayers">
                            <option value="5">5 jogadores</option>
                            <option value="6">6 jogadores</option>
                            <option value="7">7 jogadores</option>
                            <option value="8">8 jogadores</option>
                            <option value="9">9 jogadores</option>
                            <option value="10">10 jogadores</option>
                            <option value="11">11 jogadores</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="numTeams">N√∫mero de times:</label>
                        <select id="numTeams">
                            <option value="2">2 times</option>
                            <option value="3">3 times</option>
                            <option value="4">4 times</option>
                            <option value="5">5 times</option>
                            <option value="6">6 times</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="playersInput">Lista de Jogadores (um por linha):</label>
                        <textarea id="playersInput" placeholder="Digite um nome por linha...
    Exemplo:
    Jo√£o
    Pedro
    Carlos
    Rafael
    Maria
    Ana
    Marcos
    Lucas"></textarea>
                        <div id="playerCounter" class="player-counter">
                            0 jogadores listados
                        </div>
                    </div>

                    <div class="btn-container">
                        <div></div>
                        <button class="btn-next" id="goToStep2">Pr√≥ximo: Qualificar Jogadores</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Qualificar jogadores -->
            <div class="step" id="step2">
                <div class="card">
                    <h2>Qualificar Jogadores</h2>
                    
                    <div class="rating-info">
                        <h4>Sistema de Qualifica√ß√£o (1 a 5):</h4>
                        <p><strong>N√≠vel 1:</strong> Iniciante - T√©cnica b√°sica, ainda desenvolvendo habilidades</p>
                        <p><strong>N√≠vel 2:</strong> Intermedi√°rio - Boa t√©cnica, conhece o jogo</p>
                        <p><strong>N√≠vel 3:</strong> Avan√ßado - Muito boa t√©cnica, joga bem (PADR√ÉO)</p>
                        <p><strong>N√≠vel 4:</strong> Expert - Excelente t√©cnica, se destaca no grupo</p>
                        <p><strong>N√≠vel 5:</strong> Profissional - N√≠vel excepcional, faz a diferen√ßa</p>
                    </div>

                    <p>Atribua uma nota de 1 (menor) a 5 (maior) para cada jogador e marque se √© goleiro.</p>

                    <div id="playersList"></div>

                    <div class="btn-container">
                        <button class="btn-back" id="backToStep1">Voltar</button>
                        <button class="btn-next" id="goToStep3">Pr√≥ximo: Sortear Times</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Nomear times -->
            <div class="step" id="step3">
                <div class="card">
                    <h2>Nomear Times</h2>
                    
                    <div class="naming-info">
                        <h4>üè∑Ô∏è Personalize os Nomes dos Times</h4>
                        <p>Voc√™ pode dar nomes personalizados para cada time ou deixar em branco para usar nomes de cores padr√£o.</p>
                        <p><strong>Nomes padr√£o:</strong> AMARELO, AZUL, VERDE, VERMELHO, BRANCO, PRETO, etc.</p>
                    </div>

                    <div id="teamNamingGrid" class="team-naming-grid"></div>

                    <div class="btn-container">
                        <button class="btn-back" id="backToStep2">Voltar</button>
                        <button class="btn-next" id="goToStep4">Pr√≥ximo: Ver Times Finais</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Times sorteados -->
            <div class="step" id="step4">
                <div class="card">
                    <h2>Times Sorteados</h2>
                    <p>Os times foram sorteados de forma equilibrada com base nas qualifica√ß√µes.</p>

                    <div id="teamsResult"></div>

                    <div class="btn-container">
                        <button class="btn-back" id="backToStep3">Voltar</button>
                        <div style="display: flex; gap: 10px;">
                            <button id="shareWhatsApp" style="background-color: #25D366; display: flex; align-items: center; gap: 8px;">
                                <span>üì§</span> Compartilhar no WhatsApp
                            </button>
                            <button id="startGames" style="background-color: #198754;">Iniciar Jogos</button>
                            <button id="newDraw">Novo Sorteio</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Step 5: Administra√ß√£o de jogos -->
            <div class="step" id="step5">
                <div class="card">
                    <h2 id="gameTitle">Administra√ß√£o de Jogos</h2>
                    
                    <!-- Configura√ß√£o do tipo de jogo -->
                    <div id="gameConfigSection">
                        <div class="form-group">
                            <label for="gameMode">Tipo de Jogo:</label>
                            <select id="gameMode">
                                <option value="continuous">Jogo Cont√≠nuo (sem limite)</option>
                                <option value="timed">Tempo ou Gols (primeiro que atingir)</option>
                            </select>
                        </div>

                        <div id="timedGameOptions" style="display: none;">
                            <div class="form-group">
                                <label for="gameTime">Tempo Limite (minutos):</label>
                                <input type="number" id="gameTime" value="10" min="1" max="120">
                            </div>
                            <div class="form-group">
                                <label for="goalLimit">Limite de Gols:</label>
                                <input type="number" id="goalLimit" value="2" min="1" max="20">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="team1Select">Time 1:</label>
                            <select id="team1Select"></select>
                        </div>

                        <div class="form-group">
                            <label for="team2Select">Time 2:</label>
                            <select id="team2Select"></select>
                        </div>

                        <button id="startMatch" style="width: 100%; background-color: #198754; font-size: 18px; padding: 15px;">
                            üèÅ Iniciar Partida
                        </button>
                    </div>

                    <!-- Gerenciamento de Jogadores -->
                    <div id="playerManagementSection" style="display: none;">
                        <div class="player-management">
                            <h4>‚öôÔ∏è Gerenciar Jogadores</h4>
                            <div class="management-actions">
                                <button class="action-btn add-player-btn" id="addPlayerBtn">‚ûï Adicionar Jogador</button>
                                <button class="action-btn swap-players-btn" id="swapPlayersBtn">üîÑ Mover Jogadores</button>
                            </div>
                            
                            <div id="addPlayerSection" class="add-player-section" style="display: none;">
                                <h5>Adicionar Novo Jogador:</h5>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="newPlayerName" placeholder="Nome do jogador" style="flex: 1;">
                                    <select id="newPlayerTeam" style="width: 150px;">
                                        <option value="">Selecione o time</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button id="confirmAddPlayer" style="background-color: var(--secondary-color);">Adicionar</button>
                                    <button id="cancelAddPlayer" style="background-color: var(--gray-color);">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interface do jogo -->
                    <div id="gamePlaySection" style="display: none;">
                        <div class="game-header">
                            <div class="match-info">
                                <h3 id="matchTitle">Time 1 vs Time 2</h3>
                                <div id="gameTypeInfo" class="game-type-info"></div>
                            </div>
                            
                            <div class="scoreboard">
                                <div class="team-score">
                                    <div id="team1Name" class="team-name-score">Time 1</div>
                                    <div id="team1Score" class="score">0</div>
                                </div>
                                <div class="vs">VS</div>
                                <div class="team-score">
                                    <div id="team2Name" class="team-name-score">Time 2</div>
                                    <div id="team2Score" class="score">0</div>
                                </div>
                            </div>

                            <div class="timer-section">
                                <div id="timer" class="timer">00:00</div>
                                <div class="timer-controls">
                                    <button id="playPauseBtn" class="timer-btn">‚ñ∂Ô∏è Iniciar</button>
                                    <button id="endGameBtn" class="timer-btn" style="background-color: #dc3545;">üèÅ Fim de Jogo</button>
                                </div>
                            </div>
                        </div>

                        <div class="teams-container">
                            <div class="team-panel">
                                <h4 id="team1PanelName">Time 1</h4>
                                <div id="team1Players" class="players-list"></div>
                            </div>
                            
                            <div class="goal-panel">
                                <h4>Gols e Assist√™ncias</h4>
                                <div class="goal-controls">
                                    <button id="goalBtn" class="goal-btn">‚öΩ GOOOOL</button>
                                </div>
                                
                                <div id="goalHistory" class="goal-history">
                                    <h5>Hist√≥rico de Gols:</h5>
                                    <div id="goalsList"></div>
                                </div>
                            </div>

                            <div class="team-panel">
                                <h4 id="team2PanelName">Time 2</h4>
                                <div id="team2Players" class="players-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado do jogo -->
                    <div id="gameResultSection" style="display: none;">
                        <div class="game-result">
                            <h3>üèÜ Resultado Final</h3>
                            <div id="finalScore" class="final-score"></div>
                            <div id="finalResult" class="final-result"></div>
                            <div id="matchSummary" class="match-summary"></div>
                        </div>
                        
                        <div class="btn-container">
                            <button id="nextMatchBtn" style="background-color: #198754;">Pr√≥ximo Jogo</button>
                            <button id="finishTournamentBtn" style="background-color: #0d6efd;">Finalizar Torneio</button>
                        </div>
                    </div>

                    <div class="btn-container" id="gameBackBtn" style="display: none;">
                        <button class="btn-back" id="backToStep4">Voltar aos Times</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
	    <!-- Modais -->
	    <div id="customModal" class="custom-modal">
	        <div class="modal-content">
	            <div class="modal-header">‚ö†Ô∏è Aten√ß√£o</div>
	            <div class="modal-body" id="modalMessage"></div>
	            <div class="modal-footer">
	                <button class="modal-btn" id="modalOkButton">OK</button>
	            </div>
	        </div>
	    </div>
	
	    <div id="backConfirmModal" class="custom-modal">
	        <div class="modal-content">
	            <div class="modal-header">ü§î Manter Qualifica√ß√µes?</div>
	            <div class="modal-body">
	                Voc√™ j√° atribuiu qualifica√ß√µes aos jogadores. O que deseja fazer?
	            </div>
	            <div class="modal-footer">
	                <button class="modal-btn" id="keepRatingsBtn" style="background-color: #198754; margin-right: 10px;">
	                    Manter Qualifica√ß√µes
	                </button>
	                <button class="modal-btn" id="clearRatingsBtn" style="background-color: #dc3545;">
	                    Apagar Qualifica√ß√µes
	                </button>
	            </div>
	        </div>
	    </div>
	
	    <!-- Modal para marcar gol -->
	    <div id="goalModal" class="goal-modal">
	        <div class="goal-modal-content">
	            <div class="goal-modal-header">‚öΩ GOOOOL</div>
	            
	            <div class="goal-modal-teams">
	                <div class="goal-modal-team">
	                    <h5 id="goalModalTeam1Name">Time 1</h5>
	                    <div id="goalModalTeam1Players" class="goal-modal-players"></div>
	                </div>
	                <div class="goal-modal-team">
	                    <h5 id="goalModalTeam2Name">Time 2</h5>
	                    <div id="goalModalTeam2Players" class="goal-modal-players"></div>
	                </div>
	            </div>
	
	            <div class="goal-modal-options">
	                <h5>Op√ß√µes do Gol</h5>
	                <div class="goal-option">
	                    <input type="checkbox" id="ownGoalCheck">
	                    <label for="ownGoalCheck">Gol Contra</label>
	                </div>
	                
	                <div class="assist-section">
	                    <h6>Assist√™ncia (opcional):</h6>
	                    <select id="assistSelect" class="assist-select">
	                        <option value="">Nenhuma assist√™ncia</option>
	                    </select>
	                </div>
	            </div>
	
	            <div class="goal-modal-footer">
	                <button class="goal-modal-btn cancel" id="goalModalCancel">Cancelar</button>
	                <button class="goal-modal-btn confirm" id="goalModalConfirm" disabled>Confirmar Gol</button>
	            </div>
	        </div>
	    </div>
        <!-- Modal de Troca de Jogadores -->
        <div id="playerSwapModal" class="player-swap-modal">
            <div class="swap-modal-content">
                <div class="goal-modal-header">üîÑ Mover Jogadores</div>
                <p>Clique nos bot√µes para mover jogadores livremente entre os times:</p>
                
                <div id="swapTeamsGrid" class="swap-teams-grid"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="goal-modal-btn cancel" id="cancelSwapBtn" style="width: 200px;">Fechar</button>
                </div>
            </div>
        </div>
        <!-- Modal de Aviso para Times com Poucos Jogadores -->
        <div id="teamWarningModal" class="warning-modal">
            <div class="warning-modal-content">
                <div class="warning-modal-header">
                    <h3>‚ö†Ô∏è Times com Poucos Jogadores</h3>
                </div>
                <div class="warning-modal-body">
                    <p>Os seguintes times est√£o com menos jogadores do que o recomendado:</p>
                    <div id="warningTeamsList" class="warning-teams-list"></div>
                    <p><strong>Deseja continuar mesmo assim?</strong></p>
                    <p style="font-size: 14px; color: #666; margin-top: 15px;">
                        Voc√™ pode adicionar mais jogadores ou fazer ajustes antes de fechar.
                    </p>
                </div>
                <div class="warning-modal-footer">
                    <button class="warning-modal-btn warning-cancel-btn" id="warningCancelBtn">
                        üîß Fazer Ajustes
                    </button>
                    <button class="warning-modal-btn warning-continue-btn" id="warningContinueBtn">
                        ‚úÖ Continuar Assim
                    </button>
                </div>
            </div>
        </div>
	    <script>
            console.log('URL atual:', window.location.href);
            console.log('Host atual:', window.location.host);
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBcGgA86Baia0Uirb6ffpI6XCfXFKgf1y0",
                authDomain: "sorteador-times.firebaseapp.com",
                projectId: "sorteador-times",
                storageBucket: "sorteador-times.firebasestorage.app",
                messagingSenderId: "371643766511",
                appId: "1:371643766511:web:a8177cd930ed9922feed1a"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Global variables Firebase
            let currentUser = null;
            let autoSaveInterval = null;

            var currentTeams = [];
            var savedRatings = {};
            var teamNames = [];

            // Contador simples de uso do Firebase
            var contadorFirebase = {
                leituras: 0,
                escritas: 0,
                
                contarLeitura: function() {
                    this.leituras++;
                    this.mostrarUso();
                },
                
                contarEscrita: function() {
                    this.escritas++;
                    this.mostrarUso();
                },
                
                mostrarUso: function() {
                    console.log('üìä Uso Firebase hoje: ' + this.leituras + ' leituras, ' + this.escritas + ' escritas');
                    
                    // Alerta se usar muito
                    if (this.escritas > 50) {
                        console.warn('‚ö†Ô∏è Muitas escritas no Firebase hoje!');
                    }
                },
                
                verRelatorio: function() {
                    alert('üìä USO DO FIREBASE HOJE:\n\n' +
                        'üìñ Leituras: ' + this.leituras + '/50.000 por dia\n' +
                        '‚úèÔ∏è Escritas: ' + this.escritas + '/20.000 por dia\n\n' +
                        (this.escritas > 100 ? '‚ö†Ô∏è Uso alto detectado!' : '‚úÖ Uso normal'));
                }
            };

            var gameData = {
                teams: [],
                matches: [],
                currentMatch: null,
                timer: { minutes: 0, seconds: 0, interval: null, running: false },
                gameMode: 'continuous',
                timeLimit: 10,
                goalLimit: 2,
                tournamentStats: {}
            };

            var selectedGoalPlayer = null;
            var defaultTeamNames = [
                'AMARELO', 'AZUL', 'VERDE', 'VERMELHO', 'BRANCO', 'PRETO',
                'LARANJA', 'ROSA', 'ROXO', 'MARROM', 'CINZA', 'DOURADO'
            ];

            function clearAuthMessage() {
                document.getElementById('authMessage').innerHTML = '';
            }

            function showAuthForm(formType) {
                document.getElementById('loginForm').style.display = formType === 'login' ? 'block' : 'none';
                document.getElementById('registerForm').style.display = formType === 'register' ? 'block' : 'none';
                document.getElementById('forgotPasswordForm').style.display = formType === 'forgot' ? 'block' : 'none';
                clearAuthMessage();
            }

            function showAuthSection() {
                console.log('Mostrando tela de autentica√ß√£o');
                var authSection = document.getElementById('authSection');
                var mainApp = document.getElementById('mainApp');
                
                if (authSection) {
                    authSection.style.display = 'block';
                }
                if (mainApp) {
                    mainApp.classList.remove('visible');
                    mainApp.style.display = 'none';
                }
            }

            function showMainApp() {
                console.log('Mostrando aplica√ß√£o principal');
                var authSection = document.getElementById('authSection');
                var mainApp = document.getElementById('mainApp');
                var userInfo = document.getElementById('userInfo');
                var userName = document.getElementById('userName');
                var historySection = document.getElementById('historySection');
                
                if (authSection) {
                    authSection.style.display = 'none';
                }
                if (mainApp) {
                    mainApp.classList.add('visible');
                    mainApp.style.display = 'block';
                }
                if (userInfo) {
                    userInfo.classList.add('visible');
                }
                if (userName && currentUser) {
                    userName.textContent = currentUser.email.split('@')[0];
                }
                if (historySection) {
                    historySection.style.display = 'block';
                }
            }

            // Authentication state listener
            auth.onAuthStateChanged(function(user) {
                console.log('Estado de autentica√ß√£o mudou:', user ? 'logado' : 'deslogado');
                
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadUserHistory();
                    startAutoSave();
                    loadCurrentGame();
                } else {
                    currentUser = null;
                    showAuthSection();
                    stopAutoSave();
                }
            });
            
            // Auto-save functions
            function startAutoSave() {
                if (autoSaveInterval) clearInterval(autoSaveInterval);
                
                let lastSaveData = null;
                
                autoSaveInterval = setInterval(function() {
                    // Verificar se as vari√°veis existem antes de tentar salvar
                    if (typeof currentTeams !== 'undefined' && 
                        typeof gameData !== 'undefined' && 
                        (currentTeams.length > 0 || gameData.currentMatch)) {
                        
                        const currentData = JSON.stringify({
                            currentTeams: currentTeams,
                            gameData: gameData,
                            playersInput: document.getElementById('playersInput') ? 
                                document.getElementById('playersInput').value : ''
                        });
                        
                        if (currentData !== lastSaveData) {
                            saveCurrentGameState();
                            lastSaveData = currentData;
                            console.log('üîÑ Auto-save executado - dados alterados');
                        }
                    }
                }, 30000);
            }

            function stopAutoSave() {
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
            }

            async function saveCurrentGameState() {
                if (!currentUser) {
                    console.log('‚ùå Auto-save cancelado: usu√°rio n√£o logado');
                    return;
                }
                
                try {
                    console.log('üîÑ Iniciando auto-save completo...');
                    showSaveIndicator('saving');
                    
                    // CONTAR A OPERA√á√ÉO
                    if (typeof contadorFirebase !== 'undefined') {
                        contadorFirebase.contarEscrita();
                    }
                    
                    // CAPTURAR QUALIFICA√á√ïES DIRETAMENTE DA INTERFACE (se estiver no step 2)
                    var currentRatings = {};
                    var currentStep = getCurrentStep();
                    
                    if (currentStep === 2) {
                        console.log('üìä Capturando qualifica√ß√µes da interface (Step 2)...');
                        currentRatings = captureCurrentRatings();
                    } else {
                        // Se n√£o estiver no step 2, usar as qualifica√ß√µes j√° salvas
                        currentRatings = savedRatings || {};
                    }
                    
                    console.log('üíæ Qualifica√ß√µes a serem salvas:', Object.keys(currentRatings).length, 'jogadores');
                    console.log('üìã Dados das qualifica√ß√µes:', currentRatings);
                    
                    // DADOS COMPLETOS PARA RESTAURA√á√ÉO PERFEITA
                    const gameState = {
                        // Configura√ß√µes b√°sicas
                        gameType: document.getElementById('gameType') ? document.getElementById('gameType').value : 'futsal',
                        societyPlayers: document.getElementById('societyPlayers') ? document.getElementById('societyPlayers').value : '5',
                        numTeams: document.getElementById('numTeams') ? document.getElementById('numTeams').value : '2',
                        
                        // Lista de jogadores como STRING
                        playersInputText: document.getElementById('playersInput') ? document.getElementById('playersInput').value : '',
                        
                        // Times sorteados (DADOS ESSENCIAIS)
                        hasTeamsSorted: currentTeams && currentTeams.length > 0,
                        teamsData: currentTeams && currentTeams.length > 0 ? JSON.stringify(currentTeams) : '',
                        teamNamesData: teamNames && teamNames.length > 0 ? teamNames.join('|') : '',
                        
                        // QUALIFICA√á√ïES - usar as capturadas da interface
                        savedRatingsData: Object.keys(currentRatings).length > 0 ? JSON.stringify(currentRatings) : '',
                        
                        // Estado atual do step
                        currentStep: currentStep,
                        
                        // Dados do jogo ativo (se houver)
                        hasActiveGame: !!(gameData && gameData.currentMatch),
                        gameDataComplete: gameData ? JSON.stringify({
                            teams: gameData.teams || [],
                            matches: gameData.matches || [],
                            currentMatch: gameData.currentMatch || null,
                            timer: gameData.timer || { minutes: 0, seconds: 0, running: false },
                            gameMode: gameData.gameMode || 'continuous',
                            timeLimit: gameData.timeLimit || 10,
                            goalLimit: gameData.goalLimit || 2,
                            tournamentStats: gameData.tournamentStats || {}
                        }) : '',
                        
                        // Timestamp
                        lastSaved: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('üì¶ Salvando dados completos:', {
                        gameType: gameState.gameType,
                        playersCount: gameState.playersInputText.split('\n').filter(x => x.trim()).length,
                        ratingsCount: Object.keys(currentRatings).length,
                        hasTeamsSorted: gameState.hasTeamsSorted,
                        teamsCount: gameState.teamNamesData.split('|').filter(x => x.trim()).length,
                        currentStep: gameState.currentStep,
                        hasActiveGame: gameState.hasActiveGame
                    });
                    
                    // Salvar no Firebase
                    await db.collection('users').doc(currentUser.uid)
                        .collection('games').doc('current').set(gameState);
                    
                    showSaveIndicator('saved');
                    console.log('‚úÖ Auto-save completo realizado com sucesso');
                    
                } catch (error) {
                    console.error('‚ùå ERRO no auto-save completo:', error);
                    showSaveIndicator('error');
                }
            }

            // Nova fun√ß√£o para capturar qualifica√ß√µes da interface
            function captureCurrentRatings() {
                var ratings = {};
                var playersList = document.getElementById('playersList');
                
                if (!playersList) {
                    console.log('‚ö†Ô∏è Lista de jogadores n√£o encontrada para capturar qualifica√ß√µes');
                    return ratings;
                }
                
                var playerCards = playersList.querySelectorAll('.player-card');
                console.log('üîç Capturando qualifica√ß√µes de', playerCards.length, 'cards...');
                
                for (var i = 0; i < playerCards.length; i++) {
                    var card = playerCards[i];
                    var nameElement = card.querySelector('.player-name');
                    
                    if (!nameElement) {
                        console.log('‚ö†Ô∏è Nome do jogador n√£o encontrado no card', i);
                        continue;
                    }
                    
                    var playerName = nameElement.textContent.trim();
                    
                    // Capturar rating selecionado
                    var ratingInput = card.querySelector('input[name="rating_' + i + '"]:checked');
                    var rating = ratingInput ? parseInt(ratingInput.value) : 3;
                    
                    // Capturar status de goleiro
                    var gkInput = card.querySelector('input[name="goalkeeper_' + i + '"]');
                    var isGoalkeeper = gkInput ? gkInput.checked : false;
                    
                    ratings[playerName] = {
                        rating: rating,
                        isGoalkeeper: isGoalkeeper
                    };
                    
                    console.log('üìä Capturado:', playerName, '- Rating:', rating, '- Goleiro:', isGoalkeeper);
                }
                
                console.log('‚úÖ Qualifica√ß√µes capturadas:', Object.keys(ratings).length, 'jogadores');
                return ratings;
            }

            function getCurrentStep() {
                try {
                    // Verificar qual step est√° ativo
                    for (var i = 1; i <= 5; i++) {
                        var step = document.getElementById('step' + i);
                        if (step && step.classList.contains('active')) {
                            console.log('üìç Step atual detectado:', i);
                            return i;
                        }
                    }
                    
                    // Se nenhum step estiver ativo, retornar 1
                    console.log('üìç Nenhum step ativo, assumindo step 1');
                    return 1;
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao detectar step atual:', e);
                    return 1;
                }
            }

            async function loadCurrentGame() {
                if (!currentUser) return;
                
                try {
                    console.log('üîç Verificando jogo salvo...');
                    
                    // CONTAR A OPERA√á√ÉO
                    contadorFirebase.contarLeitura();
                    
                    const doc = await db.collection('users').doc(currentUser.uid)
                        .collection('games').doc('current').get();
                    
                    if (doc.exists) {
                        const savedState = doc.data();
                        console.log('üìÅ Jogo encontrado:', savedState);
                        
                        // Verificar se tem dados significativos para restaurar
                        var hasSignificantData = false;
                        var dataTypes = [];
                        
                        if (savedState.playersInputText && savedState.playersInputText.trim()) {
                            hasSignificantData = true;
                            dataTypes.push('jogadores');
                        }
                        if (savedState.hasTeamsSorted) {
                            hasSignificantData = true;
                            dataTypes.push('times sorteados');
                        }
                        if (savedState.hasActiveGame) {
                            hasSignificantData = true;
                            dataTypes.push('jogo ativo');
                        }
                        
                        console.log('üìä Tipos de dados encontrados:', dataTypes);
                        
                        if (hasSignificantData) {
                            // Para jogos ativos, restaurar automaticamente
                            if (savedState.hasActiveGame) {
                                console.log('üéÆ Restaurando jogo ativo automaticamente...');
                                
                                // Dar tempo suficiente para a interface carregar
                                setTimeout(function() {
                                    console.log('üöÄ Iniciando restaura√ß√£o do jogo ativo...');
                                    restoreUltraSimpleState(savedState);
                                }, 2000); // Aumentado para 2 segundos
                                
                            } else {
                                // Para outros casos, perguntar ao usu√°rio
                                var message = '';
                                if (savedState.hasTeamsSorted) {
                                    message = '‚öΩ TIMES SORTEADOS ENCONTRADOS!\n\nVoc√™ tem times j√° sorteados salvos. Deseja continuar com eles?';
                                } else {
                                    message = 'üìù CONFIGURA√á√ÉO SALVA!\n\nVoc√™ tem uma configura√ß√£o de jogo salva. Deseja continuar de onde parou?';
                                }
                                
                                if (confirm(message)) {
                                    setTimeout(function() {
                                        restoreUltraSimpleState(savedState);
                                    }, 1000);
                                } else {
                                    console.log('üë§ Usu√°rio optou por n√£o restaurar');
                                }
                            }
                            
                        } else {
                            console.log('üì≠ Jogo salvo sem dados significativos');
                        }
                    } else {
                        console.log('üì≠ Nenhum jogo salvo encontrado');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar jogo:', error);
                }
            }

            function restoreUltraSimpleState(savedState) {
                try {
                    console.log('üîÑ INICIANDO restaura√ß√£o exata do estado...');
                    console.log('üìã Dados recebidos:', savedState);
                    
                    // 1. RESTAURAR CONFIGURA√á√ïES B√ÅSICAS
                    if (savedState.gameType && document.getElementById('gameType')) {
                        document.getElementById('gameType').value = savedState.gameType;
                        
                        var societyContainer = document.getElementById('societyPlayersContainer');
                        if (societyContainer) {
                            societyContainer.style.display = savedState.gameType === 'society' ? 'block' : 'none';
                        }
                    }
                    
                    if (savedState.societyPlayers && document.getElementById('societyPlayers')) {
                        document.getElementById('societyPlayers').value = savedState.societyPlayers;
                    }
                    
                    if (savedState.numTeams && document.getElementById('numTeams')) {
                        document.getElementById('numTeams').value = savedState.numTeams;
                    }
                    
                    // 2. RESTAURAR LISTA DE JOGADORES
                    if (savedState.playersInputText && document.getElementById('playersInput')) {
                        document.getElementById('playersInput').value = savedState.playersInputText;
                        
                        // Atualizar contador
                        var playersInput = document.getElementById('playersInput');
                        var playerCounter = document.getElementById('playerCounter');
                        if (playersInput && playerCounter) {
                            var playerNames = playersInput.value.split('\n').filter(function(name) {
                                return name.trim() !== '';
                            });
                            var count = playerNames.length;
                            playerCounter.textContent = count + ' jogador' + (count !== 1 ? 'es' : '') + ' listado' + (count !== 1 ? 's' : '');
                        }
                    }
                    
                    // 3. RESTAURAR QUALIFICA√á√ïES
                    if (savedState.savedRatingsData) {
                        try {
                            savedRatings = JSON.parse(savedState.savedRatingsData);
                            console.log('‚úÖ Qualifica√ß√µes restauradas:', Object.keys(savedRatings).length, 'jogadores');
                            console.log('üìä Dados restaurados:', savedRatings);
                            
                            // Verificar se os dados foram restaurados corretamente
                            Object.keys(savedRatings).forEach(function(playerName) {
                                console.log('üë§', playerName, '- Rating:', savedRatings[playerName].rating, '- Goleiro:', savedRatings[playerName].isGoalkeeper);
                            });
                        } catch (e) {
                            console.error('‚ùå Erro ao restaurar qualifica√ß√µes:', e);
                            savedRatings = {};
                        }
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma qualifica√ß√£o salva encontrada');
                        savedRatings = {};
                    }
                    
                    // 4. RESTAURAR TIMES SORTEADOS
                    if (savedState.hasTeamsSorted && savedState.teamsData) {
                        try {
                            currentTeams = JSON.parse(savedState.teamsData);
                            
                            if (savedState.teamNamesData) {
                                teamNames = savedState.teamNamesData.split('|').filter(function(name) {
                                    return name.trim() !== '';
                                });
                            } else {
                                teamNames = [];
                            }
                            console.log('‚úÖ Times sorteados restaurados:', currentTeams.length, 'times');
                        } catch (e) {
                            currentTeams = [];
                            teamNames = [];
                        }
                    }
                    
                    // 5. RESTAURAR DADOS DO JOGO (mas n√£o for√ßar ir para step 5)
                    if (savedState.hasActiveGame && savedState.gameDataComplete) {
                        try {
                            gameData = JSON.parse(savedState.gameDataComplete);
                            console.log('‚úÖ Dados do jogo restaurados (sem for√ßar step 5)');
                        } catch (e) {
                            console.error('‚ùå Erro ao restaurar gameData:', e);
                        }
                    }
                    
                    // 6. DETERMINAR STEP CORRETO - USAR O STEP SALVO COMO PRIORIDADE
                    var targetStep = 1;
                    
                    if (savedState.currentStep) {
                        // SEMPRE usar o step salvo como prioridade principal
                        targetStep = savedState.currentStep;
                        console.log('üéØ Usando step salvo como prioridade:', targetStep);
                    } else {
                        // S√≥ se n√£o tiver step salvo, usar l√≥gica de fallback
                        if (savedState.hasActiveGame && gameData && gameData.currentMatch) {
                            targetStep = 5;
                        } else if (savedState.hasTeamsSorted && currentTeams && currentTeams.length > 0) {
                            targetStep = 4;
                        }
                        console.log('üéØ Step determinado por fallback:', targetStep);
                    }
                    
                    console.log('üìç Step final determinado:', targetStep);
                    
                    // 7. EXECUTAR TRANSI√á√ÉO PARA O STEP CORRETO
                    setTimeout(function() {
                        // Mudar step manualmente
                        var steps = document.querySelectorAll('.step');
                        var stepDots = document.querySelectorAll('.step-dot');
                        
                        for (var i = 0; i < steps.length; i++) {
                            steps[i].classList.remove('active');
                        }
                        for (var i = 0; i < stepDots.length; i++) {
                            stepDots[i].classList.remove('active');
                        }
                        
                        var targetStepElement = document.getElementById('step' + targetStep);
                        var targetDotElement = document.querySelector('.step-dot[data-step="' + targetStep + '"]');
                        
                        if (targetStepElement) {
                            targetStepElement.classList.add('active');
                            console.log('‚úÖ Step', targetStep, 'ativado');
                        }
                        if (targetDotElement) {
                            targetDotElement.classList.add('active');
                            console.log('‚úÖ Dot do step', targetStep, 'ativado');
                        }
                        
                        // 8. EXECUTAR A√á√ïES ESPEC√çFICAS POR STEP
                        setTimeout(function() {
                            executeStepSpecificActions(targetStep, savedState);
                        }, 300);
                        
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå Erro na restaura√ß√£o:', error);
                }
            }

            function executeStepSpecificActions(targetStep, savedState) {
                console.log('üé¨ Executando a√ß√µes espec√≠ficas para step:', targetStep);
                
                if (targetStep === 2) {
                    // STEP 2: Restaurar qualifica√ß√µes na interface
                    console.log('üîÑ Executando a√ß√µes do Step 2...');
                    console.log('üìù Texto de jogadores dispon√≠vel:', document.getElementById('playersInput') ? document.getElementById('playersInput').value : 'N√ÉO ENCONTRADO');
                    console.log('‚≠ê Qualifica√ß√µes salvas:', savedRatings);
                    
                    setTimeout(function() {
                        restoreRatingsInterface();
                    }, 200);                    
                } else if (targetStep === 3) {
                    // STEP 3: Mostrar interface de nomea√ß√£o
                    setTimeout(function() {
                        if (currentTeams && currentTeams.length > 0) {
                            reconstructTeamNamingInterface();
                        }
                    }, 200);
                    
                } else if (targetStep === 4) {
                    // STEP 4: Mostrar times sorteados
                    setTimeout(function() {
                        if (currentTeams && currentTeams.length > 0) {
                            reconstructStep4Display();
                        }
                    }, 200);
                    
                } else if (targetStep === 5) {
                    // STEP 5: Configurar interface do jogo
                    setTimeout(function() {
                        if (gameData && gameData.currentMatch) {
                            setupRestoredMatchInterface();
                        } else {
                            // Se n√£o tem jogo ativo, mostrar interface de configura√ß√£o
                            showGameConfigInterface();
                        }
                    }, 200);
                }
                
                // Mensagem de sucesso espec√≠fica
                setTimeout(function() {
                    showStepRestoreMessage(targetStep, savedState);
                }, 1000);
            }

            function restoreRatingsInterface() {
                console.log('‚≠ê Restaurando interface de qualifica√ß√µes...');
                console.log('üìã savedRatings dispon√≠vel:', savedRatings);
                console.log('üìä N√∫mero de qualifica√ß√µes salvas:', Object.keys(savedRatings).length);
                
                var playersInput = document.getElementById('playersInput');
                var playersList = document.getElementById('playersList');
                
                if (!playersInput || !playersList) {
                    console.log('‚ùå Elementos de qualifica√ß√£o n√£o encontrados');
                    return;
                }
                
                var playersText = playersInput.value;
                console.log('üìù Texto dos jogadores:', playersText);
                
                if (!playersText || playersText.trim() === '') {
                    console.log('‚ùå Nenhum texto de jogadores encontrado');
                    return;
                }
                
                var playerNames = playersText.split('\n').filter(function(name) {
                    return name.trim() !== '';
                });
                
                console.log('üë• Jogadores encontrados:', playerNames.length, playerNames);
                
                if (playerNames.length === 0) {
                    console.log('‚ùå Nenhum jogador v√°lido na lista');
                    return;
                }
                
                // Limpar lista atual
                playersList.innerHTML = '';
                console.log('üßπ Lista de jogadores limpa');
                
                // Recriar cards de qualifica√ß√£o para cada jogador
                for (var i = 0; i < playerNames.length; i++) {
                    var name = playerNames[i].trim();
                    console.log('üîß Criando card para jogador:', name);
                    
                    // Verificar se tem qualifica√ß√£o salva para este jogador
                    var savedRating = null;
                    var savedIsGoalkeeper = false;
                    
                    if (savedRatings && savedRatings[name]) {
                        savedRating = savedRatings[name].rating;
                        savedIsGoalkeeper = savedRatings[name].isGoalkeeper;
                        console.log('üìä Qualifica√ß√£o encontrada para', name, '- Rating:', savedRating, '- Goleiro:', savedIsGoalkeeper);
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma qualifica√ß√£o salva para', name, '- usando padr√£o');
                    }
                    
                    var playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    
                    // Criar op√ß√µes de rating (1 a 5)
                    var ratingOptions = '';
                    for (var j = 1; j <= 5; j++) {
                        var checked = '';
                        
                        if (savedRating !== null) {
                            // Se tem qualifica√ß√£o salva, usar ela
                            if (j === savedRating) {
                                checked = 'checked';
                                console.log('‚úÖ Aplicando rating salvo', j, 'para', name);
                            }
                        } else {
                            // Se n√£o tem qualifica√ß√£o salva, usar padr√£o 3
                            if (j === 3) {
                                checked = 'checked';
                                console.log('üìå Aplicando rating padr√£o 3 para', name);
                            }
                        }
                        
                        ratingOptions += '<label class="rating-option">';
                        ratingOptions += '<input type="radio" name="rating_' + i + '" value="' + j + '" ' + checked + '>';
                        ratingOptions += j;
                        ratingOptions += '</label>';
                    }
                    
                    // Montar HTML do card
                    playerCard.innerHTML = 
                        '<div class="player-name">' + name + '</div>' +
                        '<div class="player-ratings">' +
                            '<div class="rating-options">' + ratingOptions + '</div>' +
                            '<div class="goalkeeper-checkbox">' +
                                '<label><input type="checkbox" name="goalkeeper_' + i + '" ' + (savedIsGoalkeeper ? 'checked' : '') + '> Goleiro</label>' +
                            '</div>' +
                        '</div>';
                    
                    playersList.appendChild(playerCard);
                    console.log('‚úÖ Card criado para', name);
                }
                
                console.log('üéâ Interface de qualifica√ß√µes restaurada com', playerNames.length, 'jogadores');
                
                // Verifica√ß√£o final detalhada
                setTimeout(function() {
                    var cards = playersList.querySelectorAll('.player-card');
                    console.log('üîç VERIFICA√á√ÉO FINAL: Cards criados:', cards.length);
                    
                    cards.forEach(function(card, index) {
                        var playerName = card.querySelector('.player-name').textContent;
                        var checkedRating = card.querySelector('input[type="radio"]:checked');
                        var isGkChecked = card.querySelector('input[type="checkbox"]').checked;
                        
                        var ratingValue = checkedRating ? checkedRating.value : 'NENHUM';
                        var expectedRating = savedRatings[playerName] ? savedRatings[playerName].rating : 3;
                        var expectedGk = savedRatings[playerName] ? savedRatings[playerName].isGoalkeeper : false;
                        
                        console.log('üìä RESULTADO:', playerName);
                        console.log('   - Rating aplicado:', ratingValue, '(esperado:', expectedRating + ')');
                        console.log('   - Goleiro aplicado:', isGkChecked, '(esperado:', expectedGk + ')');
                        
                        if (ratingValue != expectedRating) {
                            console.error('‚ùå ERRO: Rating n√£o foi aplicado corretamente para', playerName);
                        }
                        if (isGkChecked !== expectedGk) {
                            console.error('‚ùå ERRO: Status de goleiro n√£o foi aplicado corretamente para', playerName);
                        }
                    });
                }, 500);
            }

            function reconstructTeamNamingInterface() {
                console.log('üè∑Ô∏è Reconstruindo interface de nomea√ß√£o...');
                
                var teamNamingGrid = document.getElementById('teamNamingGrid');
                if (!teamNamingGrid || !currentTeams) return;
                
                teamNamingGrid.innerHTML = '';
                
                for (var i = 0; i < currentTeams.length; i++) {
                    var team = currentTeams[i];
                    var defaultName = teamNames[i] || ('TIME ' + (i + 1));
                    
                    var teamSum = 0;
                    for (var j = 0; j < team.length; j++) {
                        teamSum += team[j].rating;
                    }
                    var teamAvg = (teamSum / team.length).toFixed(1);
                    
                    var playersList = '';
                    var sortedTeam = team.slice().sort(function(a, b) {
                        if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
                        if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
                        return b.rating - a.rating;
                    });
                    
                    for (var j = 0; j < Math.min(3, sortedTeam.length); j++) {
                        var player = sortedTeam[j];
                        if (playersList !== '') playersList += ', ';
                        playersList += player.name;
                        if (player.isGoalkeeper) {
                            playersList += ' (GK)';
                        }
                    }
                    if (sortedTeam.length > 3) {
                        playersList += '...';
                    }
                    
                    var teamCard = document.createElement('div');
                    teamCard.className = 'team-naming-card';
                    teamCard.innerHTML = 
                        '<h4>Time ' + (i + 1) + '</h4>' +
                        '<input type="text" id="teamName_' + i + '" value="' + defaultName + '" maxlength="20">' +
                        '<div class="team-preview">' +
                            '<div class="team-preview-header">M√©dia: ' + teamAvg + '</div>' +
                            '<div class="team-preview-players">' + playersList + '</div>' +
                        '</div>';
                    
                    teamNamingGrid.appendChild(teamCard);
                }
                
                console.log('‚úÖ Interface de nomea√ß√£o reconstru√≠da');
            }

            function showGameConfigInterface() {
                console.log('‚öôÔ∏è Mostrando interface de configura√ß√£o do jogo...');
                
                var gameConfigSection = document.getElementById('gameConfigSection');
                var gamePlaySection = document.getElementById('gamePlaySection');
                var playerManagementSection = document.getElementById('playerManagementSection');
                var gameResultSection = document.getElementById('gameResultSection');
                var gameBackBtn = document.getElementById('gameBackBtn');
                
                if (gameConfigSection) gameConfigSection.style.display = 'block';
                if (gamePlaySection) gamePlaySection.style.display = 'none';
                if (playerManagementSection) playerManagementSection.style.display = 'none';
                if (gameResultSection) gameResultSection.style.display = 'none';
                if (gameBackBtn) gameBackBtn.style.display = 'block';
                
                // Popular selects de times se necess√°rio
                setTimeout(function() {
                    if (gameData && gameData.teams && gameData.teams.length > 0) {
                        populateTeamSelectsRestored();
                    }
                }, 200);
            }

            function showStepRestoreMessage(targetStep, savedState) {
                var messages = {
                    1: 'üè† Configura√ß√£o restaurada!\n\nVoc√™ pode continuar configurando seu jogo.',
                    2: '‚≠ê Qualifica√ß√µes restauradas!\n\nSuas qualifica√ß√µes foram mantidas.',
                    3: 'üè∑Ô∏è Nomes dos times restaurados!\n\nVoc√™ pode continuar personalizando os nomes.',
                    4: '‚öΩ Times sorteados restaurados!\n\nSeus times est√£o prontos para jogar.',
                    5: savedState.hasActiveGame ? 
                        'üéÆ Jogo ativo restaurado!\n\nTodos os dados da partida foram mantidos.' :
                        'üéØ Configura√ß√£o de jogos restaurada!\n\nVoc√™ pode configurar uma nova partida.'
                };
                
                var message = messages[targetStep] || '‚úÖ Estado restaurado com sucesso!';
                alert(message);
            }

            // Fun√ß√£o auxiliar para reconstruir step 4
            function reconstructStep4Display() {
                var teamsResult = document.getElementById('teamsResult');
                if (!teamsResult || !currentTeams) return;
                
                teamsResult.innerHTML = '';
                
                for (var i = 0; i < currentTeams.length; i++) {
                    var team = currentTeams[i];
                    var teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    
                    var teamName = teamNames[i] || 'Time ' + (i + 1);
                    var teamSum = 0;
                    for (var j = 0; j < team.length; j++) {
                        teamSum += team[j].rating;
                    }
                    var teamAvg = (teamSum / team.length).toFixed(1);
                    
                    var teamContent = '<div class="team-header">';
                    teamContent += '<h3 class="team-name">' + teamName + '</h3>';
                    teamContent += '<div class="team-rating">M√©dia: ' + teamAvg + '</div>';
                    teamContent += '</div>';
                    
                    team.sort(function(a, b) {
                        if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
                        if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
                        return b.rating - a.rating;
                    });
                    
                    teamContent += '<div class="team-players">';
                    for (var j = 0; j < team.length; j++) {
                        var player = team[j];
                        var playerClass = '';
                        var playerDisplayName = player.name;
                        
                        if (player.isGoalkeeper) {
                            if (player.isMakeshift) {
                                playerClass = 'makeshift-goalkeeper';
                                playerDisplayName += ' (Goleiro Improvisado)';
                            } else {
                                playerClass = 'goalkeeper';
                            }
                        }
                        
                        if (player.isFake) {
                            playerClass = 'fake-player';
                        }
                        
                        teamContent += '<div class="player-item">';
                        teamContent += '<div class="player-item-name ' + playerClass + '">' + playerDisplayName + '</div>';
                        teamContent += '<div class="player-item-rating">' + player.rating + '</div>';
                        teamContent += '</div>';
                    }
                    teamContent += '</div>';
                    
                    teamCard.innerHTML = teamContent;
                    teamsResult.appendChild(teamCard);
                }
            }

            // Fun√ß√£o para configurar interface da partida restaurada
            function setupRestoredMatchInterface() {
                if (!gameData || !gameData.currentMatch) return;
                
                var match = gameData.currentMatch;
                
                // Configurar t√≠tulos
                var matchTitle = document.getElementById('matchTitle');
                var team1Name = document.getElementById('team1Name');
                var team2Name = document.getElementById('team2Name');
                var team1PanelName = document.getElementById('team1PanelName');
                var team2PanelName = document.getElementById('team2PanelName');
                
                if (matchTitle) matchTitle.textContent = match.team1.name + ' vs ' + match.team2.name;
                if (team1Name) team1Name.textContent = match.team1.name;
                if (team2Name) team2Name.textContent = match.team2.name;
                if (team1PanelName) team1PanelName.textContent = match.team1.name;
                if (team2PanelName) team2PanelName.textContent = match.team2.name;
                
                // Configurar placar
                var team1Score = document.getElementById('team1Score');
                var team2Score = document.getElementById('team2Score');
                if (team1Score) team1Score.textContent = match.score1 || 0;
                if (team2Score) team2Score.textContent = match.score2 || 0;
                
                // Configurar timer
                var timer = document.getElementById('timer');
                var playPauseBtn = document.getElementById('playPauseBtn');
                if (timer && gameData.timer) {
                    var minutes = String(gameData.timer.minutes || 0).padStart(2, '0');
                    var seconds = String(gameData.timer.seconds || 0).padStart(2, '0');
                    timer.textContent = minutes + ':' + seconds;
                }
                if (playPauseBtn) {
                    if (gameData.timer && gameData.timer.running) {
                        playPauseBtn.textContent = '‚è∏Ô∏è Pausar';
                    } else {
                        playPauseBtn.textContent = '‚ñ∂Ô∏è Continuar';
                    }
                }
                
                // Configurar tipo de jogo
                var gameTypeInfo = document.getElementById('gameTypeInfo');
                if (gameTypeInfo) {
                    if (gameData.gameMode === 'timed') {
                        gameTypeInfo.textContent = 'Primeiro a ' + gameData.goalLimit + ' gols ou ' + gameData.timeLimit + ' minutos';
                    } else {
                        gameTypeInfo.textContent = 'Jogo cont√≠nuo - sem limite de tempo';
                    }
                }
                
                // Popular jogadores usando a l√≥gica original
                setTimeout(function() {
                    populatePlayersListRestored();
                    updateGoalHistoryRestored();
                    populateNewPlayerTeamSelectRestored();
                    populateTeamSelectsRestored();
                    setupEventListenersForRestoredGame();
                }, 200);
            }

            function populateTeamSelectsRestored() {
                console.log('üîß Populando comboboxes dos times...');
                
                var team1Select = document.getElementById('team1Select');
                var team2Select = document.getElementById('team2Select');
                
                if (!team1Select || !team2Select) {
                    console.log('‚ùå Comboboxes n√£o encontrados');
                    return;
                }
                
                // Limpar op√ß√µes existentes
                team1Select.innerHTML = '';
                team2Select.innerHTML = '';
                
                if (!gameData.teams || gameData.teams.length === 0) {
                    console.log('‚ùå Nenhum time encontrado no gameData');
                    return;
                }
                
                console.log('üìã Times dispon√≠veis:', gameData.teams.length);
                
                // Popular comboboxes com os times
                gameData.teams.forEach(function(team) {
                    // Option para team1Select
                    var option1 = document.createElement('option');
                    option1.value = team.id;
                    option1.textContent = team.name;
                    team1Select.appendChild(option1);
                    
                    // Option para team2Select
                    var option2 = document.createElement('option');
                    option2.value = team.id;
                    option2.textContent = team.name;
                    team2Select.appendChild(option2);
                    
                    console.log('‚úÖ Time adicionado aos selects:', team.name);
                });
                
                // Selecionar times diferentes por padr√£o
                if (gameData.teams.length > 1) {
                    team1Select.value = gameData.teams[0].id;
                    team2Select.value = gameData.teams[1].id;
                    console.log('‚úÖ Times padr√£o selecionados:', gameData.teams[0].name, 'vs', gameData.teams[1].name);
                }
                
                console.log('üéâ Comboboxes dos times populados com sucesso!');
            }

            function setupEventListenersForRestoredGame() {
                console.log('üîó Simulando inicializa√ß√£o normal do sistema de jogos...');
                
                // Em vez de tentar recriar, vamos simular o processo normal
                // Isso vai executar todas as fun√ß√µes de configura√ß√£o que j√° existem
                
                setTimeout(function() {
                    console.log('üéÆ Tentando executar configura√ß√£o original...');
                    
                    // 1. Executar setupGoalModal se existir
                    try {
                        if (typeof setupGoalModal === 'function') {
                            setupGoalModal();
                            console.log('‚úÖ setupGoalModal executado');
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è setupGoalModal n√£o acess√≠vel:', e.message);
                    }
                    
                    // 2. Executar setupPlayerManagement se existir  
                    try {
                        if (typeof setupPlayerManagement === 'function') {
                            setupPlayerManagement();
                            console.log('‚úÖ setupPlayerManagement executado');
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è setupPlayerManagement n√£o acess√≠vel:', e.message);
                    }
                    
                    // 3. For√ßar re-execu√ß√£o dos event listeners atrav√©s de eventos DOM
                    triggerGameSystemInitialization();
                    
                }, 500);
                
                // 4. CONFIGURAR BOT√ïES ESPEC√çFICOS QUE PRECISAM SER RESTAURADOS
                setTimeout(function() {
                    console.log('üîß Configurando bot√µes espec√≠ficos...');
                    
                    // Configurar bot√£o de adicionar jogador
                    configureAddPlayerButton();
                    
                    // 5. BOT√ÉO VOLTAR AOS TIMES
                    configureBackToTeamsButton();
                    
                    console.log('üéâ Todos os event listeners configurados para jogo restaurado!');
                }, 1000);
            }

            function configureBackToTeamsButton() {
                console.log('üîô Configurando bot√£o Voltar aos Times...');
                
                var backToStep4Btn = document.getElementById('backToStep4');
                if (!backToStep4Btn) {
                    console.log('‚ùå Bot√£o backToStep4 n√£o encontrado');
                    return;
                }
                
                // Remover event listeners anteriores
                var newBackBtn = backToStep4Btn.cloneNode(true);
                backToStep4Btn.parentNode.replaceChild(newBackBtn, backToStep4Btn);
                
                // Adicionar novo event listener
                newBackBtn.addEventListener('click', function() {
                    console.log('üîô Bot√£o Voltar aos Times clicado');
                    console.log('üìä currentTeams dispon√≠vel:', currentTeams ? currentTeams.length : 'NENHUM');
                    console.log('üè∑Ô∏è teamNames dispon√≠vel:', teamNames ? teamNames.length : 'NENHUM');
                    
                    // Ir para step 4
                    goToStep4WithTeams();
                });
                
                console.log('‚úÖ Bot√£o Voltar aos Times configurado');
            }

            function goToStep4WithTeams() {
                console.log('üèÜ Indo para Step 4 com times...');
                
                // Verificar se temos times para mostrar
                if (!currentTeams || currentTeams.length === 0) {
                    console.log('‚ùå Nenhum time sorteado encontrado');
                    alert('‚ùå Erro: Nenhum time sorteado encontrado!\n\nVoc√™ precisa sortear os times primeiro.');
                    return;
                }
                
                console.log('‚úÖ Times encontrados:', currentTeams.length);
                
                // Mudar para step 4 manualmente
                var steps = document.querySelectorAll('.step');
                var stepDots = document.querySelectorAll('.step-dot');
                
                // Desativar todos os steps
                for (var i = 0; i < steps.length; i++) {
                    steps[i].classList.remove('active');
                }
                for (var i = 0; i < stepDots.length; i++) {
                    stepDots[i].classList.remove('active');
                }
                
                // Ativar step 4
                var step4Element = document.getElementById('step4');
                var dot4Element = document.querySelector('.step-dot[data-step="4"]');
                
                if (step4Element) {
                    step4Element.classList.add('active');
                    console.log('‚úÖ Step 4 ativado');
                }
                if (dot4Element) {
                    dot4Element.classList.add('active');
                    console.log('‚úÖ Dot 4 ativado');
                }
                
                // Aguardar um pouco e ent√£o popular os times
                setTimeout(function() {
                    displayTeamsForStep4();
                }, 300);
            }

            function displayTeamsForStep4() {
                console.log('üèÜ Exibindo times no Step 4...');
                
                var teamsResult = document.getElementById('teamsResult');
                if (!teamsResult) {
                    console.log('‚ùå Elemento teamsResult n√£o encontrado');
                    return;
                }
                
                if (!currentTeams || currentTeams.length === 0) {
                    console.log('‚ùå Nenhum time para exibir');
                    teamsResult.innerHTML = '<p style="text-align: center; color: #666;">Nenhum time sorteado encontrado.</p>';
                    return;
                }
                
                console.log('üîß Reconstruindo exibi√ß√£o dos times...');
                teamsResult.innerHTML = '';
                
                for (var i = 0; i < currentTeams.length; i++) {
                    var team = currentTeams[i];
                    var teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    
                    // Nome do time
                    var teamName = 'Time ' + (i + 1);
                    if (teamNames && teamNames[i]) {
                        teamName = teamNames[i];
                    }
                    
                    // Calcular m√©dia do time
                    var teamSum = 0;
                    for (var j = 0; j < team.length; j++) {
                        teamSum += team[j].rating || 3;
                    }
                    var teamAvg = (teamSum / team.length).toFixed(1);
                    
                    // Criar conte√∫do do card
                    var teamContent = '<div class="team-header">';
                    teamContent += '<h3 class="team-name">' + teamName + '</h3>';
                    teamContent += '<div class="team-rating">M√©dia: ' + teamAvg + '</div>';
                    teamContent += '</div>';
                    
                    // Ordenar jogadores (goleiros primeiro, depois por rating)
                    var sortedTeam = team.slice().sort(function(a, b) {
                        if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
                        if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
                        return (b.rating || 3) - (a.rating || 3);
                    });
                    
                    teamContent += '<div class="team-players">';
                    for (var j = 0; j < sortedTeam.length; j++) {
                        var player = sortedTeam[j];
                        var playerClass = '';
                        var playerDisplayName = player.name;
                        
                        if (player.isGoalkeeper) {
                            if (player.isMakeshift) {
                                playerClass = 'makeshift-goalkeeper';
                                playerDisplayName += ' (Goleiro Improvisado)';
                            } else {
                                playerClass = 'goalkeeper';
                            }
                        }
                        
                        if (player.isFake) {
                            playerClass = 'fake-player';
                        }
                        
                        teamContent += '<div class="player-item">';
                        teamContent += '<div class="player-item-name ' + playerClass + '">' + playerDisplayName + '</div>';
                        teamContent += '<div class="player-item-rating">' + (player.rating || 3) + '</div>';
                        teamContent += '</div>';
                    }
                    teamContent += '</div>';
                    
                    teamCard.innerHTML = teamContent;
                    teamsResult.appendChild(teamCard);
                    
                    console.log('‚úÖ Time', teamName, 'adicionado com', team.length, 'jogadores');
                }
                
                console.log('üéâ Todos os times exibidos no Step 4');
            }

            function triggerGameSystemInitialization() {
                console.log('üöÄ For√ßando re-inicializa√ß√£o do sistema...');
                
                // Vamos simular que o step 5 acabou de ser ativado
                // para que todos os event listeners sejam configurados
                
                setTimeout(function() {
                    // Disparar evento customizado que pode ser capturado pelo sistema original
                    var gameInitEvent = new CustomEvent('gameSystemRestore', {
                        detail: { restored: true }
                    });
                    document.dispatchEvent(gameInitEvent);
                    
                    // Como √∫ltimo recurso, vamos tentar acessar as fun√ß√µes atrav√©s do DOM
                    simulateOriginalFunctionality();
                    
                }, 200);
            }

            function simulateOriginalFunctionality() {
                console.log('üîß Configurando funcionalidades b√°sicas manualmente...');
                
                // BOT√ÉO GOL - vers√£o m√≠nima funcional
                var goalBtn = document.getElementById('goalBtn');
                if (goalBtn) {
                    // Remover listener anterior
                    var newGoalBtn = goalBtn.cloneNode(true);
                    goalBtn.parentNode.replaceChild(newGoalBtn, goalBtn);
                    
                    newGoalBtn.addEventListener('click', function() {
                        // Vers√£o simplificada que funciona
                        if (!gameData.currentMatch) {
                            alert('Nenhuma partida ativa!');
                            return;
                        }
                        
                        // Abrir modal simples para gol
                        openSimpleGoalModal();
                    });
                    console.log('‚úÖ Bot√£o Gol configurado (vers√£o simples)');
                }
                
                // BOT√ÉO MOVER JOGADORES - vers√£o funcional
                var swapPlayersBtn = document.getElementById('swapPlayersBtn');
                if (swapPlayersBtn) {
                    var newSwapPlayersBtn = swapPlayersBtn.cloneNode(true);
                    swapPlayersBtn.parentNode.replaceChild(newSwapPlayersBtn, swapPlayersBtn);
                    
                    newSwapPlayersBtn.addEventListener('click', function() {
                        // Vers√£o simplificada que funciona
                        openSimpleSwapModal();
                    });
                    console.log('‚úÖ Bot√£o Mover Jogadores configurado (vers√£o simples)');
                }

                // BOT√ÉO ADICIONAR JOGADOR - usar evento de clique direto
                setTimeout(function() {
                    configureAddPlayerButton();
                }, 500);
            }

            // Nova fun√ß√£o espec√≠fica para configurar o bot√£o Adicionar Jogador
            function configureAddPlayerButton() {
                var addPlayerBtn = document.getElementById('addPlayerBtn');
                if (!addPlayerBtn) {
                    console.log('‚ùå Bot√£o Adicionar Jogador n√£o encontrado');
                    return;
                }
                
                console.log('üîß Configurando bot√£o Adicionar Jogador...');
                
                // Verificar se j√° tem event listener funcionando
                if (addPlayerBtn.onclick || addPlayerBtn.addEventListener) {
                    // Tentar disparar um clique para testar
                    console.log('üß™ Testando event listener existente...');
                    
                    // Se o event listener original n√£o estiver funcionando, adicionar um novo
                    var testWorked = false;
                    
                    // Adicionar event listener com namespace √∫nico
                    var newListener = function(e) {
                        console.log('üü¢ Event listener do Adicionar Jogador ativado!');
                        testWorked = true;
                        
                        var section = document.getElementById('addPlayerSection');
                        if (section) {
                            if (section.style.display === 'none' || !section.style.display) {
                                section.style.display = 'block';
                                var nameInput = document.getElementById('newPlayerName');
                                if (nameInput) {
                                    nameInput.focus();
                                }
                                console.log('‚úÖ Se√ß√£o de adicionar jogador aberta');
                            } else {
                                section.style.display = 'none';
                                document.getElementById('newPlayerName').value = '';
                                document.getElementById('newPlayerTeam').value = '';
                                console.log('‚úÖ Se√ß√£o de adicionar jogador fechada');
                            }
                        } else {
                            console.log('‚ùå Se√ß√£o addPlayerSection n√£o encontrada');
                        }
                    };
                    
                    // Remover listeners anteriores e adicionar novo
                    var newAddPlayerBtn = addPlayerBtn.cloneNode(true);
                    addPlayerBtn.parentNode.replaceChild(newAddPlayerBtn, addPlayerBtn);
                    
                    newAddPlayerBtn.addEventListener('click', newListener);
                    
                    console.log('‚úÖ Event listener do bot√£o Adicionar Jogador configurado');
                    
                    // Tamb√©m configurar os bot√µes de confirmar e cancelar
                    setTimeout(function() {
                        configureAddPlayerActions();
                    }, 200);
                    
                } else {
                    console.log('‚ùå Bot√£o Adicionar Jogador n√£o tem event listeners');
                }
            }

            function configureAddPlayerActions() {
                var confirmAddPlayer = document.getElementById('confirmAddPlayer');
                var cancelAddPlayer = document.getElementById('cancelAddPlayer');
                
                if (confirmAddPlayer) {
                    var newConfirmBtn = confirmAddPlayer.cloneNode(true);
                    confirmAddPlayer.parentNode.replaceChild(newConfirmBtn, confirmAddPlayer);
                    
                    newConfirmBtn.addEventListener('click', function() {
                        console.log('üü¢ Bot√£o Confirmar Adicionar clicado');
                        
                        var name = document.getElementById('newPlayerName').value.trim();
                        var teamId = parseInt(document.getElementById('newPlayerTeam').value);
                        
                        if (!name) {
                            alert('Digite o nome do jogador!');
                            return;
                        }
                        
                        if (!teamId) {
                            alert('Selecione um time!');
                            return;
                        }
                        
                        var team = gameData.teams.find(function(t) { return t.id === teamId; });
                        if (!team) {
                            alert('Time n√£o encontrado!');
                            return;
                        }
                        
                        var newPlayer = {
                            name: name,
                            rating: 3,
                            isGoalkeeper: false,
                            isFake: false,
                            originalTeam: teamId,
                            currentTeam: teamId,
                            isNew: true
                        };
                        
                        team.players.push(newPlayer);
                        
                        // Atualizar partida ativa se necess√°rio
                        if (gameData.currentMatch && (gameData.currentMatch.team1.id === teamId || gameData.currentMatch.team2.id === teamId)) {
                            // Adicionar √† partida ativa
                            if (gameData.currentMatch.team1.id === teamId) {
                                gameData.currentMatch.team1.players.push(newPlayer);
                            }
                            if (gameData.currentMatch.team2.id === teamId) {
                                gameData.currentMatch.team2.players.push(newPlayer);
                            }
                            
                            populatePlayersListRestored();
                        }
                        
                        // Fechar se√ß√£o
                        document.getElementById('addPlayerSection').style.display = 'none';
                        document.getElementById('newPlayerName').value = '';
                        document.getElementById('newPlayerTeam').value = '';
                        
                        alert('‚úÖ Jogador ' + name + ' adicionado ao time ' + team.name + '!');
                        
                        console.log('‚úÖ Jogador adicionado com sucesso:', newPlayer);
                    });
                    
                    console.log('‚úÖ Bot√£o Confirmar Adicionar configurado');
                }
                
                if (cancelAddPlayer) {
                    var newCancelBtn = cancelAddPlayer.cloneNode(true);
                    cancelAddPlayer.parentNode.replaceChild(newCancelBtn, cancelAddPlayer);
                    
                    newCancelBtn.addEventListener('click', function() {
                        document.getElementById('addPlayerSection').style.display = 'none';
                        document.getElementById('newPlayerName').value = '';
                        document.getElementById('newPlayerTeam').value = '';
                        console.log('‚úÖ Adicionar jogador cancelado');
                    });
                    
                    console.log('‚úÖ Bot√£o Cancelar Adicionar configurado');
                }
            }

            // Modal simples para gols
            function openSimpleGoalModal() {
                var modal = document.getElementById('goalModal');
                if (!modal || !gameData.currentMatch) return;
                
                // Reset do modal
                selectedGoalPlayer = null;
                document.getElementById('ownGoalCheck').checked = false;
                document.getElementById('goalModalConfirm').disabled = true;
                
                // Configurar nomes dos times
                document.getElementById('goalModalTeam1Name').textContent = gameData.currentMatch.team1.name;
                document.getElementById('goalModalTeam2Name').textContent = gameData.currentMatch.team2.name;
                
                // Popular jogadores team 1
                var team1Container = document.getElementById('goalModalTeam1Players');
                team1Container.innerHTML = '';
                gameData.currentMatch.team1.players.forEach(function(player) {
                    if (!player.isFake) {
                        var playerDiv = document.createElement('div');
                        playerDiv.className = 'goal-modal-player';
                        playerDiv.textContent = player.name;
                        playerDiv.onclick = function() { 
                            selectGoalPlayerSimple(player, 1, playerDiv); 
                        };
                        team1Container.appendChild(playerDiv);
                    }
                });
                
                // Popular jogadores team 2
                var team2Container = document.getElementById('goalModalTeam2Players');
                team2Container.innerHTML = '';
                gameData.currentMatch.team2.players.forEach(function(player) {
                    if (!player.isFake) {
                        var playerDiv = document.createElement('div');
                        playerDiv.className = 'goal-modal-player';
                        playerDiv.textContent = player.name;
                        playerDiv.onclick = function() { 
                            selectGoalPlayerSimple(player, 2, playerDiv); 
                        };
                        team2Container.appendChild(playerDiv);
                    }
                });
                
                // Configurar assist√™ncias
                var assistSelect = document.getElementById('assistSelect');
                assistSelect.innerHTML = '<option value="">Nenhuma assist√™ncia</option>';
                
                modal.style.display = 'block';
            }

            function selectGoalPlayerSimple(player, team, element) {
                // Remover sele√ß√µes anteriores
                var allPlayers = document.querySelectorAll('.goal-modal-player');
                allPlayers.forEach(function(p) { p.classList.remove('selected'); });
                
                // Marcar sele√ß√£o atual
                element.classList.add('selected');
                selectedGoalPlayer = { player: player, team: team };
                
                // Habilitar bot√£o confirmar
                document.getElementById('goalModalConfirm').disabled = false;
                
                // Popular assist√™ncias do mesmo time
                var assistSelect = document.getElementById('assistSelect');
                assistSelect.innerHTML = '<option value="">Nenhuma assist√™ncia</option>';
                
                var teamPlayers = team === 1 ? gameData.currentMatch.team1.players : gameData.currentMatch.team2.players;
                teamPlayers.forEach(function(p) {
                    if (!p.isFake && p.name !== player.name) {
                        var option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = p.name;
                        assistSelect.appendChild(option);
                    }
                });
            }

            // Modal completo para troca de jogadores
            function openSimpleSwapModal() {
                var modal = document.getElementById('playerSwapModal');
                if (!modal) return;
                
                // Popular times para troca
                populateTeamsForSwapSimple();
                modal.style.display = 'block';
            }

            function populateTeamsForSwapSimple() {
                var teamsGrid = document.getElementById('swapTeamsGrid');
                if (!teamsGrid) return;
                
                teamsGrid.innerHTML = '';
                
                var gameType = document.getElementById('gameType') ? document.getElementById('gameType').value : 'futsal';
                var minPlayers = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
                
                gameData.teams.forEach(function(team) {
                    var teamSection = document.createElement('div');
                    teamSection.className = 'swap-team-section';
                    
                    var realPlayers = team.players.filter(function(p) { return !p.isFake; });
                    var playersCount = realPlayers.length;
                    
                    var countClass = playersCount < minPlayers ? 'warning-text' : '';
                    var countText = playersCount + ' jogador' + (playersCount !== 1 ? 'es' : '');
                    if (playersCount < minPlayers) {
                        countText += ' (M√≠n: ' + minPlayers + ')';
                    }
                    
                    teamSection.innerHTML = '<h5>' + team.name + '</h5>' +
                                        '<div class="team-players-count ' + countClass + '">' + countText + '</div>' +
                                        '<div id="team_' + team.id + '_players"></div>';
                    
                    var playersContainer = teamSection.querySelector('#team_' + team.id + '_players');
                    
                    realPlayers.forEach(function(player) {
                        var playerDiv = document.createElement('div');
                        playerDiv.className = 'swap-player-item';
                        
                        // Nome do jogador
                        var playerNameDiv = document.createElement('div');
                        playerNameDiv.innerHTML = '<strong>' + player.name + '</strong>';
                        playerDiv.appendChild(playerNameDiv);
                        
                        // Container para os bot√µes
                        var buttonsContainer = document.createElement('div');
                        buttonsContainer.style.marginTop = '5px';
                        
                        // Bot√£o de deletar
                        var deleteButton = document.createElement('button');
                        deleteButton.className = 'delete-player-btn';
                        deleteButton.textContent = 'üóëÔ∏è Deletar';
                        deleteButton.onclick = function() {
                            deletePlayerSimple(player.name, team.id, team.name);
                        };
                        buttonsContainer.appendChild(deleteButton);
                        
                        // Bot√µes para mover para outros times
                        gameData.teams.forEach(function(targetTeam) {
                            if (targetTeam.id !== team.id) {
                                var moveButton = document.createElement('button');
                                moveButton.className = 'move-player-btn';
                                moveButton.style.margin = '2px';
                                moveButton.style.fontSize = '10px';
                                moveButton.textContent = '‚Üí ' + targetTeam.name;
                                
                                moveButton.onclick = function() {
                                    movePlayerSimple(player.name, team.id, targetTeam.id, team.name, targetTeam.name);
                                };
                                
                                buttonsContainer.appendChild(moveButton);
                            }
                        });
                        
                        playerDiv.appendChild(buttonsContainer);
                        playersContainer.appendChild(playerDiv);
                    });
                    
                    teamsGrid.appendChild(teamSection);
                });
            }

            function deletePlayerSimple(playerName, teamId, teamName) {
                if (!confirm('ATEN√á√ÉO: Tem certeza que deseja DELETAR o jogador "' + playerName + '" do time "' + teamName + '"?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
                    return;
                }
                
                var team = gameData.teams.find(function(t) { return t.id === teamId; });
                if (!team) return;
                
                // Remover do time global
                var playerIndex = team.players.findIndex(function(p) { return p.name === playerName; });
                if (playerIndex !== -1) {
                    team.players.splice(playerIndex, 1);
                }
                
                // Remover da partida ativa se necess√°rio
                if (gameData.currentMatch) {
                    if (gameData.currentMatch.team1.id === teamId) {
                        var matchPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                        if (matchPlayerIndex !== -1) {
                            gameData.currentMatch.team1.players.splice(matchPlayerIndex, 1);
                        }
                    }
                    
                    if (gameData.currentMatch.team2.id === teamId) {
                        var matchPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                        if (matchPlayerIndex !== -1) {
                            gameData.currentMatch.team2.players.splice(matchPlayerIndex, 1);
                        }
                    }
                    
                    // Atualizar interface da partida
                    populatePlayersListRestored();
                }
                
                // Atualizar modal
                populateTeamsForSwapSimple();
                
                alert('Jogador ' + playerName + ' foi deletado do time ' + teamName + '!');
            }

            function movePlayerSimple(playerName, sourceTeamId, targetTeamId, sourceTeamName, targetTeamName) {
                var sourceTeam = gameData.teams.find(function(t) { return t.id === sourceTeamId; });
                var targetTeam = gameData.teams.find(function(t) { return t.id === targetTeamId; });
                
                if (!sourceTeam || !targetTeam) return;
                
                // Encontrar e remover jogador do time atual
                var playerIndex = sourceTeam.players.findIndex(function(p) { return p.name === playerName; });
                if (playerIndex === -1) return;
                
                var player = sourceTeam.players.splice(playerIndex, 1)[0];
                player.currentTeam = targetTeam.id;
                
                // Adicionar ao novo time
                targetTeam.players.push(player);
                
                // Atualizar partida ativa se necess√°rio
                if (gameData.currentMatch) {
                    // Remover do time ativo atual
                    if (gameData.currentMatch.team1.id === sourceTeamId) {
                        var matchPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                        if (matchPlayerIndex !== -1) {
                            gameData.currentMatch.team1.players.splice(matchPlayerIndex, 1);
                        }
                    }
                    
                    if (gameData.currentMatch.team2.id === sourceTeamId) {
                        var matchPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                        if (matchPlayerIndex !== -1) {
                            gameData.currentMatch.team2.players.splice(matchPlayerIndex, 1);
                        }
                    }
                    
                    // Adicionar ao time ativo de destino
                    if (gameData.currentMatch.team1.id === targetTeamId) {
                        var existingPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                        if (existingPlayerIndex === -1) {
                            gameData.currentMatch.team1.players.push(player);
                        }
                    }
                    
                    if (gameData.currentMatch.team2.id === targetTeamId) {
                        var existingPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                        if (existingPlayerIndex === -1) {
                            gameData.currentMatch.team2.players.push(player);
                        }
                    }
                    
                    // Atualizar interface da partida
                    populatePlayersListRestored();
                }
                
                // Atualizar modal
                populateTeamsForSwapSimple();
                
                alert('‚úÖ Jogador ' + playerName + ' movido de ' + sourceTeamName + ' para ' + targetTeamName + '!');
            }

            // Configurar bot√£o de fechar do modal de troca
            setTimeout(function() {
                var cancelSwapBtn = document.getElementById('cancelSwapBtn');
                if (cancelSwapBtn && !cancelSwapBtn.onclick) {
                    cancelSwapBtn.onclick = function() {
                        // Verificar se h√° times com poucos jogadores
                        var gameType = document.getElementById('gameType') ? document.getElementById('gameType').value : 'futsal';
                        var minPlayers = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
                        
                        var teamsWithFewPlayers = [];
                        gameData.teams.forEach(function(team) {
                            var realPlayers = team.players.filter(function(p) { return !p.isFake; });
                            if (realPlayers.length < minPlayers) {
                                teamsWithFewPlayers.push({
                                    name: team.name,
                                    playerCount: realPlayers.length,
                                    minPlayers: minPlayers
                                });
                            }
                        });
                        
                        if (teamsWithFewPlayers.length > 0) {
                            var warningMessage = '‚ö†Ô∏è ATEN√á√ÉO: Os seguintes times est√£o com poucos jogadores:\n\n';
                            teamsWithFewPlayers.forEach(function(team) {
                                warningMessage += '‚Ä¢ ' + team.name + ': ' + team.playerCount + '/' + team.minPlayers + ' jogadores\n';
                            });
                            warningMessage += '\nDeseja continuar mesmo assim?';
                            
                            if (confirm(warningMessage)) {
                                document.getElementById('playerSwapModal').style.display = 'none';
                            }
                        } else {
                            document.getElementById('playerSwapModal').style.display = 'none';
                        }
                    };
                }
            }, 1000);

            // Configurar modais se ainda n√£o estiverem configurados
            setTimeout(function() {
                var goalModalCancel = document.getElementById('goalModalCancel');
                var goalModalConfirm = document.getElementById('goalModalConfirm');
                
                if (goalModalCancel && !goalModalCancel.onclick) {
                    goalModalCancel.onclick = function() {
                        document.getElementById('goalModal').style.display = 'none';
                        selectedGoalPlayer = null;
                    };
                }
                
                if (goalModalConfirm && !goalModalConfirm.onclick) {
                    goalModalConfirm.onclick = function() {
                        if (!selectedGoalPlayer) return;
                        
                        var isOwnGoal = document.getElementById('ownGoalCheck').checked;
                        var assistPlayer = document.getElementById('assistSelect').value;
                        
                        // Adicionar gol usando l√≥gica simplificada
                        addGoalSimple(selectedGoalPlayer, isOwnGoal, assistPlayer);
                        
                        document.getElementById('goalModal').style.display = 'none';
                    };
                }
            }, 1000);

            function addGoalSimple(goalData, isOwnGoal, assist) {
                var match = gameData.currentMatch;
                if (!match.goals) match.goals = [];
                
                var goalPlayerTeamName = goalData.team === 1 ? match.team1.name : match.team2.name;
                
                var goal = {
                    player: goalData.player.name,
                    playerTeam: goalPlayerTeamName,
                    type: isOwnGoal ? 'own' : 'normal',
                    time: gameData.timer.minutes + ':' + String(gameData.timer.seconds).padStart(2, '0'),
                    team: goalData.team,
                    assist: assist || null
                };
                
                match.goals.push(goal);
                
                // Atualizar placar
                if (isOwnGoal) {
                    if (goalData.team === 1) {
                        match.score2++;
                    } else {
                        match.score1++;
                    }
                } else {
                    if (goalData.team === 1) {
                        match.score1++;
                    } else {
                        match.score2++;
                    }
                }
                
                // Atualizar interface
                document.getElementById('team1Score').textContent = match.score1;
                document.getElementById('team2Score').textContent = match.score2;
                
                // Atualizar contador do jogador
                if (!isOwnGoal) {
                    var playerGoalSpan = document.getElementById('goals-' + goalData.player.name.replace(/\s+/g, ''));
                    if (playerGoalSpan) {
                        var currentGoals = parseInt(playerGoalSpan.textContent) || 0;
                        playerGoalSpan.textContent = currentGoals + 1;
                    }
                }
                
                // Atualizar hist√≥rico
                updateGoalHistoryRestored();
                
                console.log('‚öΩ Gol adicionado:', goal);
            }

            // Fun√ß√£o para popular lista de jogadores restaurada
            function populatePlayersListRestored() {
                var team1Players = document.getElementById('team1Players');
                var team2Players = document.getElementById('team2Players');
                
                if (!team1Players || !team2Players || !gameData.currentMatch) return;
                
                team1Players.innerHTML = '';
                team2Players.innerHTML = '';
                
                var match = gameData.currentMatch;
                
                // Team 1
                if (match.team1.players) {
                    match.team1.players.forEach(function(player) {
                        if (!player.isFake) {
                            var playerDiv = document.createElement('div');
                            playerDiv.className = 'player-item-game';
                            
                            var goalCount = 0;
                            if (match.goals) {
                                match.goals.forEach(function(goal) {
                                    if (goal.player === player.name && goal.type !== 'own') {
                                        goalCount++;
                                    }
                                });
                            }
                            
                            playerDiv.innerHTML = '<span>' + player.name + '</span><span class="player-goals" id="goals-' + 
                                player.name.replace(/\s+/g, '') + '">' + goalCount + '</span>';
                            team1Players.appendChild(playerDiv);
                        }
                    });
                }
                
                // Team 2
                if (match.team2.players) {
                    match.team2.players.forEach(function(player) {
                        if (!player.isFake) {
                            var playerDiv = document.createElement('div');
                            playerDiv.className = 'player-item-game';
                            
                            var goalCount = 0;
                            if (match.goals) {
                                match.goals.forEach(function(goal) {
                                    if (goal.player === player.name && goal.type !== 'own') {
                                        goalCount++;
                                    }
                                });
                            }
                            
                            playerDiv.innerHTML = '<span>' + player.name + '</span><span class="player-goals" id="goals-' + 
                                player.name.replace(/\s+/g, '') + '">' + goalCount + '</span>';
                            team2Players.appendChild(playerDiv);
                        }
                    });
                }
            }

            // Fun√ß√£o para atualizar hist√≥rico de gols
            function updateGoalHistoryRestored() {
                var goalsList = document.getElementById('goalsList');
                if (!goalsList || !gameData.currentMatch || !gameData.currentMatch.goals) return;
                
                goalsList.innerHTML = '';
                
                gameData.currentMatch.goals.forEach(function(goal) {
                    var goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-item';
                    
                    var goalText = goal.time + ' - ' + goal.player + ' (' + goal.playerTeam + ')';
                    if (goal.type === 'own') {
                        goalText += ' (Gol Contra)';
                    }
                    if (goal.assist) {
                        goalText += ' (Assist: ' + goal.assist + ')';
                    }
                    
                    goalDiv.textContent = goalText;
                    goalsList.appendChild(goalDiv);
                });
            }

            // Fun√ß√£o para popular select de times
            function populateNewPlayerTeamSelectRestored() {
                var newPlayerTeamSelect = document.getElementById('newPlayerTeam');
                if (!newPlayerTeamSelect || !gameData.teams) return;
                
                newPlayerTeamSelect.innerHTML = '<option value="">Selecione o time</option>';
                
                gameData.teams.forEach(function(team) {
                    var option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    newPlayerTeamSelect.appendChild(option);
                });
            }

            function restoreGameState(savedState) {
                document.getElementById('gameType').value = savedState.gameType || 'futsal';
                document.getElementById('societyPlayers').value = savedState.societyPlayers || '5';
                document.getElementById('numTeams').value = savedState.numTeams || '2';
                document.getElementById('playersInput').value = savedState.playersInput || '';
                
                currentTeams = savedState.currentTeams || [];
                teamNames = savedState.teamNames || [];
                savedRatings = savedState.savedRatings || {};
                
                if (savedState.gameData) {
                    gameData = savedState.gameData;
                }
                
                if (savedState.gameType === 'society') {
                    document.getElementById('societyPlayersContainer').style.display = 'block';
                }
                
                updatePlayerCounter();
            }

            // Fun√ß√£o para verificar se todas as fun√ß√µes necess√°rias existem
            function verifyRequiredFunctions() {
                console.log('üîç VERIFICANDO FUN√á√ïES NECESS√ÅRIAS...');
                
                var functions = [
                    'showStep',
                    'displayTeams', 
                    'initializeGameSystem',
                    'updatePlayerCounter'
                ];
                
                var missing = [];
                
                functions.forEach(function(funcName) {
                    if (typeof window[funcName] === 'function') {
                        console.log('‚úÖ', funcName, 'encontrada');
                    } else {
                        console.error('‚ùå', funcName, 'N√ÉO encontrada');
                        missing.push(funcName);
                    }
                });
                
                if (missing.length > 0) {
                    console.error('üö® FUN√á√ïES FALTANDO:', missing);
                    return false;
                }
                
                console.log('‚úÖ Todas as fun√ß√µes necess√°rias est√£o dispon√≠veis');
                return true;
            }

            async function saveGameToHistory(gameResult) {
                if (!currentUser) return;
                
                try {
                    const completeGameResult = {
                        ...gameResult,
                        tournamentStats: gameData.tournamentStats,
                        matches: gameData.matches,
                        teamsData: gameData.teams,
                        gameConfig: {
                            gameType: document.getElementById('gameType').value,
                            gameMode: gameData.gameMode,
                            timeLimit: gameData.timeLimit,
                            goalLimit: gameData.goalLimit
                        },
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(currentUser.uid)
                        .collection('gameHistory').add(completeGameResult);
                    
                    await db.collection('users').doc(currentUser.uid)
                        .collection('games').doc('current').delete();
                    
                    loadUserHistory();
                    showSaveIndicator('saved');
                } catch (error) {
                    console.error('Erro ao salvar no hist√≥rico:', error);
                    showSaveIndicator('error');
                }
            }

            async function loadUserHistory() {
                if (!currentUser) return;
                
                try {
                    // CONTAR A OPERA√á√ÉO
                    contadorFirebase.contarLeitura();
                    
                    console.log('üîç Carregando hist√≥rico do Firebase...');
                    
                    const snapshot = await db.collection('users').doc(currentUser.uid)
                        .collection('gameHistory')
                        .orderBy('completedAt', 'desc')
                        .limit(10) // REDUZIDO de 20 para 10 para economizar
                        .get();
                    
                    displayHistory(snapshot.docs);
                    console.log('üì¶ Hist√≥rico carregado: ' + snapshot.docs.length + ' jogos');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar hist√≥rico:', error);
                }
            }

            function displayHistory(historyDocs) {
                const historyItems = document.getElementById('historyItems');
                historyItems.innerHTML = '';
                
                if (historyDocs.length === 0) {
                    historyItems.innerHTML = '<p style="text-align: center; color: #666;">Nenhum jogo salvo ainda.</p>';
                    return;
                }
                
                historyDocs.forEach(doc => {
                    const game = doc.data();
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'history-item';
                    
                    const date = game.completedAt ? game.completedAt.toDate() : new Date();
                    const dateStr = date.toLocaleDateString('pt-BR') + ' √†s ' + 
                                date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    
                    const totalGoals = game.tournamentStats?.playerGoals ? 
                        Object.values(game.tournamentStats.playerGoals).reduce((a, b) => a + b, 0) : 0;
                    
                    const totalMatches = game.matches ? game.matches.length : 0;
                    
                    const topScorer = game.tournamentStats?.playerGoals ? 
                        Object.entries(game.tournamentStats.playerGoals)
                            .sort((a, b) => b[1] - a[1])[0] : null;
                    
                    gameDiv.innerHTML = `
                        <div class="history-date">${dateStr}</div>
                        <div class="history-teams">${game.teams || 'Torneio Completo'}</div>
                        <div class="history-score">${game.finalScore || 'M√∫ltiplas partidas'}</div>
                        <div class="history-stats">
                            üéØ ${totalGoals} gols ‚Ä¢ üèÜ ${totalMatches} partidas
                            ${topScorer ? `‚Ä¢ üëë ${topScorer[0]} (${topScorer[1]} gols)` : ''}
                        </div>
                        <div style="margin-top: 8px;">
                            <button class="load-game-btn" onclick="viewGameDetails('${doc.id}')">Ver Detalhes</button>
                            <button class="delete-history-btn" onclick="deleteGameHistory('${doc.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                    
                    historyItems.appendChild(gameDiv);
                });
            }

            async function viewGameDetails(gameId) {
                try {
                    const doc = await db.collection('users').doc(currentUser.uid)
                        .collection('gameHistory').doc(gameId).get();
                    
                    if (doc.exists) {
                        const gameData = doc.data();
                        showGameDetailsModal(gameData);
                    }
                } catch (error) {
                    console.error('Erro ao carregar detalhes:', error);
                    alert('Erro ao carregar detalhes do jogo');
                }
            }

            function showGameDetailsModal(gameData) {
                let details = `üìä DETALHES DO JOGO\n\n`;
                details += `üìÖ Data: ${gameData.completedAt ? gameData.completedAt.toDate().toLocaleDateString('pt-BR') : 'N/A'}\n`;
                details += `‚öΩ Modalidade: ${gameData.gameConfig?.gameType || 'N/A'}\n`;
                details += `‚è±Ô∏è Dura√ß√£o: ${gameData.duration || 'N/A'}\n\n`;
                
                if (gameData.tournamentStats) {
                    const stats = gameData.tournamentStats;
                    
                    if (stats.playerGoals && Object.keys(stats.playerGoals).length > 0) {
                        details += `üèÜ ARTILHEIROS:\n`;
                        Object.entries(stats.playerGoals)
                            .sort((a, b) => b[1] - a[1])
                            .forEach((entry, index) => {
                                details += `${index + 1}¬∫ ${entry[0]} - ${entry[1]} gol${entry[1] !== 1 ? 's' : ''}\n`;
                            });
                        details += '\n';
                    }
                    
                    if (stats.playerAssists && Object.keys(stats.playerAssists).length > 0) {
                        details += `üÖ∞Ô∏è ASSIST√äNCIAS:\n`;
                        Object.entries(stats.playerAssists)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .forEach((entry, index) => {
                                details += `${index + 1}¬∫ ${entry[0]} - ${entry[1]} assist${entry[1] !== 1 ? 's' : ''}\n`;
                            });
                        details += '\n';
                    }
                }
                
                if (gameData.matches && gameData.matches.length > 0) {
                    details += `üìã RESULTADOS:\n`;
                    gameData.matches.forEach((match, index) => {
                        details += `${index + 1}. ${match.team1.name} ${match.score1} x ${match.score2} ${match.team2.name}`;
                        if (match.winner) {
                            details += ` (${match.winner.name})`;
                        }
                        details += '\n';
                    });
                    details += '\n';
                }
                
                details += `üé≤ Gerado pelo Sorteador de Times`;
                alert(details);
            }

            async function deleteGameHistory(gameId) {
                if (!confirm('Tem certeza que deseja deletar este jogo do hist√≥rico?')) return;
                
                try {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('gameHistory').doc(gameId).delete();
                    
                    loadUserHistory();
                    alert('Jogo removido do hist√≥rico!');
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar jogo do hist√≥rico');
                }
            }

            function showSaveIndicator(status) {
                const indicator = document.getElementById('saveIndicator');
                indicator.className = 'save-indicator';
                
                switch (status) {
                    case 'saving':
                        indicator.textContent = 'Salvando...';
                        indicator.classList.add('saving');
                        break;
                    case 'saved':
                        indicator.textContent = '‚úì Salvo Automaticamente';
                        break;
                    case 'error':
                        indicator.textContent = '‚úó Erro ao salvar';
                        indicator.classList.add('error');
                        break;
                }
                
                indicator.style.display = 'block';
                
                if (status !== 'saving') {
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 3000);
                }
            }

            // Authentication functions
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    document.getElementById('loadingAuth').style.display = 'block';
                    await auth.signInWithEmailAndPassword(email, password);
                    showAuthMessage('Login realizado com sucesso!', 'success');
                } catch (error) {
                    showAuthMessage(getErrorMessage(error.code), 'error');
                } finally {
                    document.getElementById('loadingAuth').style.display = 'none';
                }
            });

            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerPasswordConfirm').value;
                
                if (password !== confirmPassword) {
                    showAuthMessage('As senhas n√£o coincidem!', 'error');
                    return;
                }
                
                try {
                    document.getElementById('loadingAuth').style.display = 'block';
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showAuthMessage('Conta criada com sucesso!', 'success');
                } catch (error) {
                    showAuthMessage(getErrorMessage(error.code), 'error');
                } finally {
                    document.getElementById('loadingAuth').style.display = 'none';
                }
            });

            document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value;
                
                try {
                    document.getElementById('loadingAuth').style.display = 'block';
                    await auth.sendPasswordResetEmail(email);
                    showAuthMessage('Link de recupera√ß√£o enviado para seu email!', 'success');
                } catch (error) {
                    showAuthMessage(getErrorMessage(error.code), 'error');
                } finally {
                    document.getElementById('loadingAuth').style.display = 'none';
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', async function() {
                try {
                    await saveCurrentGameState();
                    await auth.signOut();
                    showAuthMessage('Logout realizado com sucesso!', 'success');
                } catch (error) {
                    showAuthMessage('Erro ao fazer logout: ' + error.message, 'error');
                }
            });

            document.getElementById('toggleHistory').addEventListener('click', function() {
                const historyList = document.getElementById('historyList');
                const isVisible = historyList.style.display !== 'none';
                historyList.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? 'Mostrar Hist√≥rico' : 'Ocultar Hist√≥rico';
                
                if (!isVisible) {
                    loadUserHistory();
                }
            });

            function showAuthMessage(message, type) {
                document.getElementById('authMessage').innerHTML = `<div class="${type}-message">${message}</div>`;
            }

            function getErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/user-not-found': 'Usu√°rio n√£o encontrado!',
                    'auth/wrong-password': 'Senha incorreta!',
                    'auth/email-already-in-use': 'Este email j√° est√° sendo usado!',
                    'auth/weak-password': 'Senha muito fraca! Use pelo menos 6 caracteres.',
                    'auth/invalid-email': 'Email inv√°lido!'
                };
                return errorMessages[errorCode] || 'Erro: ' + errorCode;
            }

            // Global functions for onclick handlers
            window.viewGameDetails = viewGameDetails;
            window.deleteGameHistory = deleteGameHistory;

            // Event listeners para autentica√ß√£o - ADICIONAR AQUI
            document.getElementById('showRegister').addEventListener('click', function(e) {
                e.preventDefault();
                showAuthForm('register');
            });

            document.getElementById('showLogin').addEventListener('click', function(e) {
                e.preventDefault();
                showAuthForm('login');
            });

            document.getElementById('showForgotPassword').addEventListener('click', function(e) {
                e.preventDefault();
                showAuthForm('forgot');
            });

            document.getElementById('backToLogin').addEventListener('click', function(e) {
                e.preventDefault();
                showAuthForm('login');
            });

            // Save before page unload
            window.addEventListener('beforeunload', function(e) {
                if (currentUser && (currentTeams.length > 0 || gameData.currentMatch)) {
                    saveCurrentGameState();
                }
            });
	        document.addEventListener('DOMContentLoaded', function() {
	            var gameTypeSelect = document.getElementById('gameType');
	            var societyPlayersContainer = document.getElementById('societyPlayersContainer');
	            var numTeamsSelect = document.getElementById('numTeams');
	            var playersInput = document.getElementById('playersInput');
	            var playersList = document.getElementById('playersList');
	            var teamsResult = document.getElementById('teamsResult');
	            var playerCounter = document.getElementById('playerCounter');
	            var teamNamingGrid = document.getElementById('teamNamingGrid');
	            
	            var goToStep2 = document.getElementById('goToStep2');
	            var goToStep3 = document.getElementById('goToStep3');
	            var goToStep4 = document.getElementById('goToStep4');
	            var backToStep1 = document.getElementById('backToStep1');
	            var backToStep2 = document.getElementById('backToStep2');
	            var backToStep3 = document.getElementById('backToStep3');
	            var backToStep4 = document.getElementById('backToStep4');
	            var newDraw = document.getElementById('newDraw');
	            var shareWhatsApp = document.getElementById('shareWhatsApp');
	            var startGames = document.getElementById('startGames');
	            
	            var steps = document.querySelectorAll('.step');
	            var stepDots = document.querySelectorAll('.step-dot');
	            
                function updatePlayerCounter() {
	                var playerNames = playersInput.value.split('\n').filter(function(name) {
	                    return name.trim() !== '';
	                });
	                var count = playerNames.length;
	                playerCounter.textContent = count + ' jogador' + (count !== 1 ? 'es' : '') + ' listado' + (count !== 1 ? 's' : '');
	            }
	
	            function shuffleArray(array) {
	                for (var i = array.length - 1; i > 0; i--) {
	                    var j = Math.floor(Math.random() * (i + 1));
	                    var temp = array[i];
	                    array[i] = array[j];
	                    array[j] = temp;
	                }
	            }
	
	            function showCustomAlert(message) {
	                var modal = document.getElementById('customModal');
	                var modalMessage = document.getElementById('modalMessage');
	                modalMessage.textContent = message;
	                modal.style.display = 'block';
	            }
	
	            function closeCustomModal() {
	                var modal = document.getElementById('customModal');
	                modal.style.display = 'none';
	            }
	
	            function showStep(stepNumber) {
	                for (var i = 0; i < steps.length; i++) {
	                    steps[i].classList.remove('active');
	                }
	                for (var i = 0; i < stepDots.length; i++) {
	                    stepDots[i].classList.remove('active');
	                }
	                
	                document.getElementById('step' + stepNumber).classList.add('active');
	                document.querySelector('.step-dot[data-step="' + stepNumber + '"]').classList.add('active');
	            }
	
	            function saveCurrentRatings() {
	                savedRatings = {};
	                var playerCards = playersList.querySelectorAll('.player-card');
	                
	                for (var i = 0; i < playerCards.length; i++) {
	                    var card = playerCards[i];
	                    var name = card.querySelector('.player-name').textContent.trim();
	                    var ratingInput = card.querySelector('input[name="rating_' + i + '"]:checked');
	                    var isGoalkeeper = card.querySelector('input[name="goalkeeper_' + i + '"]').checked;
	                    
	                    if (ratingInput) {
	                        savedRatings[name] = {
	                            rating: parseInt(ratingInput.value),
	                            isGoalkeeper: isGoalkeeper
	                        };
	                    }
	                }
	            }
	
	            function restoreSavedRatings() {
	                var playerCards = playersList.querySelectorAll('.player-card');
	                
	                for (var i = 0; i < playerCards.length; i++) {
	                    var card = playerCards[i];
	                    var name = card.querySelector('.player-name').textContent.trim();
	                    
	                    if (savedRatings[name]) {
	                        var savedData = savedRatings[name];
	                        
	                        var ratingInput = card.querySelector('input[name="rating_' + i + '"][value="' + savedData.rating + '"]');
	                        if (ratingInput) {
	                            ratingInput.checked = true;
	                        }
	                        
	                        var gkInput = card.querySelector('input[name="goalkeeper_' + i + '"]');
	                        if (gkInput) {
	                            gkInput.checked = savedData.isGoalkeeper;
	                        }
	                    }
	                }
	            }
	
	            function clearSavedRatings() {
	                savedRatings = {};
	            }
	
	            function hasAnyRatings() {
	                return Object.keys(savedRatings).length > 0;
	            }
	
	            function validatePlayerCountAtStep1(playerNames) {
	                var gameType = gameTypeSelect.value;
	                var playersPerTeam = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
	                var numTimes = parseInt(numTeamsSelect.value);
	                
	                var totalJogadores = playerNames.length;
	                var jogadoresNecessarios = numTimes * playersPerTeam;
	                var faltandoJogadores = jogadoresNecessarios - totalJogadores;
	                var excedente = totalJogadores - jogadoresNecessarios;
	                var maxJogadoresFicticios = playersPerTeam - 1;
	                
	                if (excedente > 0) {
	                    var mensagem = 'N√∫mero de jogadores inv√°lido!\n\n';
	                    mensagem += 'Voc√™ tem ' + totalJogadores + ' jogadores para ' + numTimes + ' times de ' + playersPerTeam + ' jogadores cada.\n';
	                    mensagem += 'Isso significa que ' + excedente + ' jogador' + (excedente > 1 ? 'es' : '') + ' ficar' + (excedente > 1 ? '√£o' : '√°') + ' de fora do sorteio.';
	                    showCustomAlert(mensagem);
	                    return false;
	                }
	                
	                if (faltandoJogadores > maxJogadoresFicticios) {
	                    var mensagem = 'N√∫mero de jogadores inv√°lido!\n\n';
	                    mensagem += 'Voc√™ tem ' + totalJogadores + ' jogadores para ' + numTimes + ' times de ' + playersPerTeam + ' jogadores cada.\n';
	                    mensagem += 'Faltam ' + faltandoJogadores + ' jogadores para completar os times.';
	                    showCustomAlert(mensagem);
	                    return false;
	                }
	                
	                var jogadoresMinimos = numTimes;
	                if (totalJogadores < jogadoresMinimos) {
	                    var mensagem = 'N√∫mero de jogadores insuficiente!\n\n';
	                    mensagem += 'Voc√™ precisa de pelo menos ' + jogadoresMinimos + ' jogadores (1 por time) para ' + numTimes + ' times.';
	                    showCustomAlert(mensagem);
	                    return false;
	                }
	                
	                return true;
	            }
            
            function setupTeamNaming(teams) {
              teamNamingGrid.innerHTML = '';
              teamNames = [];
              
              var shuffledDefaultNames = defaultTeamNames.slice();
              shuffleArray(shuffledDefaultNames);
              
              for (var i = 0; i < teams.length; i++) {
                  var team = teams[i];
                   var defaultName = shuffledDefaultNames[i] || 'TIME ' + (i + 1);
                   
                   var teamCard = document.createElement('div');
                   teamCard.className = 'team-naming-card';
                   
                   var teamSum = 0;
                   for (var j = 0; j < team.length; j++) {
                       teamSum += team[j].rating;
                   }
                   var teamAvg = (teamSum / team.length).toFixed(1);
                   
                   var playersList = '';
                   var sortedTeam = team.slice().sort(function(a, b) {
                       if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
                       if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
                       return b.rating - a.rating;
                   });
                   
                   for (var j = 0; j < Math.min(3, sortedTeam.length); j++) {
                       var player = sortedTeam[j];
                       if (playersList !== '') playersList += ', ';
                       playersList += player.name;
                       if (player.isGoalkeeper) {
                           playersList += ' (GK)';
                       }
                   }
                   if (sortedTeam.length > 3) {
                       playersList += '...';
                   }
                   
                   teamCard.innerHTML = 
                       '<h4>Time ' + (i + 1) + '</h4>' +
                       '<input type="text" id="teamName_' + i + '" placeholder="' + defaultName + '" maxlength="20">' +
                       '<div class="team-preview">' +
                           '<div class="team-preview-header">M√©dia: ' + teamAvg + '</div>' +
                           '<div class="team-preview-players">' + playersList + '</div>' +
                       '</div>';
                   
                   teamNamingGrid.appendChild(teamCard);
               }
           }
           function getTeamNames() {
               var names = [];
               var shuffledDefaultNames = defaultTeamNames.slice();
               shuffleArray(shuffledDefaultNames);
               
               for (var i = 0; i < currentTeams.length; i++) {
                   var input = document.getElementById('teamName_' + i);
                   var customName = input.value.trim();
                   
                   if (customName !== '') {
                       names.push(customName.toUpperCase());
                   } else {
                       names.push(shuffledDefaultNames[i] || 'TIME ' + (i + 1));
                   }
               }
               
               return names;
           }
           function createBalancedTeamsImproved(players) {
               var gameType = gameTypeSelect.value;
               var playersPerTeam = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
               var numTimes = parseInt(numTeamsSelect.value);
               
               var totalJogadores = players.length;
               var jogadoresNecessarios = numTimes * playersPerTeam;
               var faltandoJogadores = jogadoresNecessarios - totalJogadores;
               
               var goleiros = [];
               var jogadoresLinha = [];
               
               for (var i = 0; i < players.length; i++) {
                   if (players[i].isGoalkeeper) {
                       goleiros.push(players[i]);
                   } else {
                       jogadoresLinha.push(players[i]);
                   }
               }
               
               if (faltandoJogadores > 0) {
                   for (var i = 0; i < faltandoJogadores; i++) {
                       jogadoresLinha.push({
                           name: 'COMPLETE COM ALGUEM',
                           rating: 5,
                           isGoalkeeper: false,
                           isFake: true
                       });
                   }
                }
                
                shuffleArray(goleiros);
                shuffleArray(jogadoresLinha);
                
                var jogadoresPorNivel = { 1: [], 2: [], 3: [], 4: [], 5: [] };
                
                for (var i = 0; i < jogadoresLinha.length; i++) {
                    var jogador = jogadoresLinha[i];
                    jogadoresPorNivel[jogador.rating].push(jogador);
                }
                
                for (var nivel = 1; nivel <= 5; nivel++) {
                    shuffleArray(jogadoresPorNivel[nivel]);
                }
                
                var times = [];
                for (var i = 0; i < numTimes; i++) {
                    times.push({ id: i + 1, jogadores: [] });
                }
                
                function pegarProximoJogador(prioridades) {
                    for (var i = 0; i < prioridades.length; i++) {
                        var nivel = prioridades[i];
                        if (nivel === 'goleiro' && goleiros.length > 0) {
                            return goleiros.shift();
                        } else if (typeof nivel === 'number' && jogadoresPorNivel[nivel].length > 0) {
                            return jogadoresPorNivel[nivel].shift();
                        }
                    }
                    return null;
                }
                
                var rodada = 1;
                var todosTimesCompletos = false;
                
                while (!todosTimesCompletos) {
                    var prioridades = [];
                    
                    if (rodada === 1) {
                        prioridades = ['goleiro', 3, 2, 4, 1, 5];
                    } else if (rodada === 2) {
                        prioridades = [1, 2, 3, 4, 5];
                    } else if (rodada === 3) {
                        prioridades = [5, 4, 3, 2, 1];
                    } else if (rodada === 4) {
                        prioridades = [2, 3, 1, 4, 5];
                    } else if (rodada === 5) {
                        prioridades = [4, 3, 2, 5, 1];
                    } else {
                        var ciclo = ((rodada - 2) % 4) + 2;
                        if (ciclo === 2) prioridades = [1, 2, 3, 4, 5];
                        else if (ciclo === 3) prioridades = [5, 4, 3, 2, 1];
                        else if (ciclo === 4) prioridades = [2, 3, 1, 4, 5];
                        else if (ciclo === 5) prioridades = [4, 3, 2, 5, 1];
                    }
                    
                    var alguemRecebeuJogador = false;
                    
                    for (var timeIndex = 0; timeIndex < times.length; timeIndex++) {
                        var time = times[timeIndex];
                        
                        if (time.jogadores.length < playersPerTeam) {
                            var jogador = pegarProximoJogador(prioridades);
	                            
	                            if (jogador) {
	                                if (rodada === 1 && !jogador.isGoalkeeper) {
	                                    jogador = {
	                                        name: jogador.name,
	                                        rating: jogador.rating,
	                                        isGoalkeeper: true,
	                                        isMakeshift: true,
	                                        isFake: jogador.isFake || false
	                                    };
	                                }
	                                
	                                time.jogadores.push(jogador);
	                                alguemRecebeuJogador = true;
	                            }
	                        }
	                    }
	                    
	                    todosTimesCompletos = true;
	                    for (var i = 0; i < times.length; i++) {
	                        if (times[i].jogadores.length < playersPerTeam) {
	                            todosTimesCompletos = false;
	                            break;
	                        }
	                    }
	                    
	                    if (!alguemRecebeuJogador && !todosTimesCompletos) {
	                        break;
	                    }
	                    
	                    rodada++;
	                }
	                
	                for (var i = 0; i < times.length; i++) {
	                    var time = times[i];
	                    while (time.jogadores.length < playersPerTeam) {
	                        time.jogadores.push({
	                            name: 'COMPLETE COM ALGUEM',
	                            rating: 3,
	                            isGoalkeeper: false,
	                            isFake: true
	                        });
	                    }
	                }
	                
	                var result = [];
	                for (var i = 0; i < times.length; i++) {
	                    result.push(times[i].jogadores);
	                }
	                return result;
	            }
	
	            function displayTeams(teams) {
	                teamsResult.innerHTML = '';
	                teamNames = getTeamNames();
	                
	                for (var i = 0; i < teams.length; i++) {
	                    var team = teams[i];
	                    var teamCard = document.createElement('div');
	                    teamCard.className = 'team-card';
	                    
	                    var teamName = teamNames[i] || 'Time ' + (i + 1);
	                    var teamSum = 0;
	                    for (var j = 0; j < team.length; j++) {
	                        teamSum += team[j].rating;
	                    }
	                    var teamAvg = (teamSum / team.length).toFixed(1);
	                    
	                    var nivelCount = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
	                    for (var j = 0; j < team.length; j++) {
	                        nivelCount[team[j].rating]++;
	                    }
	                    
	                    var distribuicaoInfo = '';
	                    for (var nivel = 1; nivel <= 5; nivel++) {
	                        if (nivelCount[nivel] > 0) {
	                            if (distribuicaoInfo !== '') distribuicaoInfo += ' | ';
	                            distribuicaoInfo += 'N' + nivel + ':' + nivelCount[nivel];
	                        }
	                    }
	                    
	                    var teamContent = '<div class="team-header">';
	                    teamContent += '<h3 class="team-name">' + teamName + '</h3>';
	                    teamContent += '<div class="team-rating">M√©dia: ' + teamAvg + '</div>';
	                    teamContent += '</div>';
	                    teamContent += '<div style="text-align: center; font-size: 12px; color: #666; margin-bottom: 10px;">' + distribuicaoInfo + '</div>';
	                    
	                    team.sort(function(a, b) {
	                        if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
	                        if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
	                        return b.rating - a.rating;
	                    });
	                    
	                    teamContent += '<div class="team-players">';
	                    
	                    for (var j = 0; j < team.length; j++) {
	                        var player = team[j];
	                        var playerClass = '';
	                        var playerDisplayName = player.name;
	                        
	                        if (player.isGoalkeeper) {
	                            if (player.isMakeshift) {
	                                playerClass = 'makeshift-goalkeeper';
	                                playerDisplayName += ' (Goleiro Improvisado)';
	                            } else {
	                                playerClass = 'goalkeeper';
	                            }
	                        }
	                        
	                        if (player.isFake) {
	                            playerClass = 'fake-player';
	                        }
	                        
	                        teamContent += '<div class="player-item">';
	                        teamContent += '<div class="player-item-name ' + playerClass + '">' + playerDisplayName + '</div>';
	                        teamContent += '<div class="player-item-rating">' + player.rating + '</div>';
	                        teamContent += '</div>';
	                    }
	                    
	                    teamContent += '</div>';
	                    teamCard.innerHTML = teamContent;
	                    teamsResult.appendChild(teamCard);
	                }
	            }
	
	            function shareTeamsOnWhatsApp(teams) {
	                var gameType = gameTypeSelect.value;
	                var playersPerTeam = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
	                
	                var message = 'TIMES SORTEADOS\n';
	                message += gameType === 'futsal' ? 'Futsal' : 'Society';
	                message += ' (' + playersPerTeam + ' jogadores)\n\n';
	                
	                for (var i = 0; i < teams.length; i++) {
	                    var team = teams[i];
	                    var teamAvg = 0;
	                    for (var j = 0; j < team.length; j++) {
	                        teamAvg += team[j].rating;
	                    }
	                    teamAvg = (teamAvg / team.length).toFixed(1);
	                    
	                    var teamName = teamNames[i] || 'Time ' + (i + 1);
	                    message += teamName + '\n';
	                    
	                    var sortedTeam = team.slice().sort(function(a, b) {
	                        if (a.isGoalkeeper && !b.isGoalkeeper) return -1;
	                        if (!a.isGoalkeeper && b.isGoalkeeper) return 1;
	                        return a.name.localeCompare(b.name);
	                    });
	                    
	                    for (var j = 0; j < sortedTeam.length; j++) {
	                        var player = sortedTeam[j];
	                        var playerName = player.name;
	                        var emoji = '';
	                        
	                        if (player.isGoalkeeper) {
	                            emoji = 'GK';
	                            if (player.isMakeshift) {
	                                playerName += ' (Goleiro Improvisado)';
	                            } else if (!player.isFake) {
	                                playerName += ' (Goleiro)';
	                            }
	                        } else if (player.isFake) {
	                            emoji = '?';
	                        }
	                        
	                        message += emoji + ' ' + playerName + '\n';
	                    }
	                    
	                    message += '\n';
	                }
	                
	                message += 'Sorteio gerado automaticamente';
	                
	                var encodedMessage = encodeURIComponent(message);
	                var whatsappUrl = 'https://api.whatsapp.com/send?text=' + encodedMessage;
	                window.open(whatsappUrl, '_blank');
	            }
	
	            // Event Listeners
	            playersInput.addEventListener('input', updatePlayerCounter);
	            updatePlayerCounter();
	
	            gameTypeSelect.addEventListener('change', function() {
	                if (this.value === 'society') {
	                    societyPlayersContainer.style.display = 'block';
	                } else {
	                    societyPlayersContainer.style.display = 'none';
	                }
	            });
	
	            document.getElementById('modalOkButton').addEventListener('click', closeCustomModal);
	
	            window.onclick = function(event) {
	                var modal = document.getElementById('customModal');
	                var backModal = document.getElementById('backConfirmModal');
	                var goalModal = document.getElementById('goalModal');
	                if (event.target === modal) {
	                    closeCustomModal();
	                }
	                if (event.target === backModal) {
	                    backModal.style.display = 'none';
	                }
	                if (event.target === goalModal) {
	                    closeGoalModal();
	                }
	            };
	
	            goToStep2.addEventListener('click', function() {
	                var gameType = gameTypeSelect.value;
	                var playersPerTeam = gameType === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
	                
	                var playerNames = playersInput.value.split('\n').filter(function(name) {
	                    return name.trim() !== '';
	                });
	                
	                if (playerNames.length === 0) {
	                    showCustomAlert('Por favor, adicione pelo menos um jogador na lista!');
	                    return;
	                }
	                
	                if (playerNames.length < playersPerTeam) {
	                    showCustomAlert('Por favor, adicione pelo menos ' + playersPerTeam + ' jogadores!');
	                    return;
	                }
	                
	                if (!validatePlayerCountAtStep1(playerNames)) {
	                    return;
	                }
	                
	                saveCurrentRatings();
	                playersList.innerHTML = '';
	                
	                for (var i = 0; i < playerNames.length; i++) {
	                    var name = playerNames[i];
	                    var playerCard = document.createElement('div');
	                    playerCard.className = 'player-card';
	                    
	                    var ratingOptions = '';
	                    for (var j = 1; j <= 5; j++) {
	                        var checked = j === 3 ? 'checked' : '';
	                        ratingOptions += '<label class="rating-option">';
	                        ratingOptions += '<input type="radio" name="rating_' + i + '" value="' + j + '" ' + checked + '>';
	                        ratingOptions += j;
	                        ratingOptions += '</label>';
	                    }
	                    
	                    playerCard.innerHTML = '<div class="player-name">' + name.trim() + '</div>' +
	                        '<div class="player-ratings">' +
	                        '<div class="rating-options">' + ratingOptions + '</div>' +
	                        '<div class="goalkeeper-checkbox">' +
	                        '<label><input type="checkbox" name="goalkeeper_' + i + '"> Goleiro</label>' +
	                        '</div></div>';
	                    
	                    playersList.appendChild(playerCard);
	                }
	                
	                if (hasAnyRatings()) {
	                    restoreSavedRatings();
	                }
	                
	                showStep(2);
                    if (currentUser) saveCurrentGameState();
	            });
	
	            goToStep3.addEventListener('click', function() {
	                var playerCards = playersList.querySelectorAll('.player-card');
	                var players = [];
	                
	                for (var i = 0; i < playerCards.length; i++) {
	                    var card = playerCards[i];
	                    var name = card.querySelector('.player-name').textContent;
	                    var ratingInput = card.querySelector('input[name="rating_' + i + '"]:checked');
	                    var isGoalkeeper = card.querySelector('input[name="goalkeeper_' + i + '"]').checked;
	                    
	                    var rating = ratingInput ? parseInt(ratingInput.value) : 3;
	                    
	                    players.push({
	                        name: name,
	                        rating: rating,
	                        isGoalkeeper: isGoalkeeper
	                    });
	                }
	                
	                var teams = createBalancedTeamsImproved(players);
	                if (teams.length === 0) {
	                    return;
	                }
	                
	                currentTeams = teams;
	                setupTeamNaming(teams);
	                showStep(3);
                    if (currentUser) saveCurrentGameState();
	            });
	
	            goToStep4.addEventListener('click', function() {
	                teamNames = getTeamNames();
	                displayTeams(currentTeams);
	                showStep(4);
                    if (currentUser) saveCurrentGameState();
	            });
	
	            backToStep1.addEventListener('click', function() {
	                if (playersList.children.length > 0) {
	                    saveCurrentRatings();
	                    
	                    if (hasAnyRatings()) {
	                        var backModal = document.getElementById('backConfirmModal');
	                        backModal.style.display = 'block';
	                        return;
	                    }
	                }
	                
	                showStep(1);
	            });
	            
	            document.getElementById('keepRatingsBtn').addEventListener('click', function() {
	                document.getElementById('backConfirmModal').style.display = 'none';
	                showStep(1);
	            });
	            
	            document.getElementById('clearRatingsBtn').addEventListener('click', function() {
	                clearSavedRatings();
	                document.getElementById('backConfirmModal').style.display = 'none';
	                showStep(1);
	            });
	            
	            backToStep2.addEventListener('click', function() {
	                showStep(2);
	            });
	            
	            backToStep3.addEventListener('click', function() {
	                showStep(3);
	            });
	            
	            backToStep4.addEventListener('click', function() {
	                showStep(4);
	            });
	            
	            newDraw.addEventListener('click', function() {
                    if (confirm('Deseja iniciar um novo sorteio? O jogo atual ser√° salvo no hist√≥rico.')) {
                        if (currentUser && (currentTeams.length > 0 || gameData.matches.length > 0)) {
                            const gameResult = {
                                teams: teamNames.length > 0 ? teamNames.join(' vs ') : 'Times sorteados',
                                description: 'Sorteio finalizado - novo iniciado',
                                finalScore: gameData.currentMatch ? 
                                    `${gameData.currentMatch.score1} x ${gameData.currentMatch.score2}` : 
                                    'N√£o jogado',
                                duration: gameData.timer ? 
                                    `${gameData.timer.minutes}:${String(gameData.timer.seconds).padStart(2, '0')}` : 
                                    '00:00'
                            };
                            //saveGameToHistory(gameResult);
                        }
                        playersInput.value = '';
                        updatePlayerCounter();
                        teamNames = [];
                        showStep(1);
                    }
                });
	
	            shareWhatsApp.addEventListener('click', function() {
                    if (currentTeams.length > 0) {
                        shareTeamsOnWhatsApp(currentTeams);
                        
                        // Save to history when sharing
                        if (currentUser) {
                            const gameResult = {
                                teams: teamNames.join(' vs '),
                                description: 'Times compartilhados via WhatsApp',
                                finalScore: 'Times sorteados',
                                duration: '00:00'
                            };
                            //saveGameToHistory(gameResult);
                        }
                    }
                });
	
	            startGames.addEventListener('click', function() {
	                if (currentTeams.length < 2) {
	                    showCustomAlert('√â necess√°rio ter pelo menos 2 times para iniciar os jogos!');
	                    return;
	                }
	                initializeGameSystem();
	                showStep(5);
	            });
	
	            // Sistema de Jogos
	            function initializeGameSystem() {
                    gameData.teams = currentTeams.map(function(team, index) {
                        return {
                            id: index + 1,
                            name: teamNames[index] || 'Time ' + (index + 1),
                            players: team.map(function(player) {
                                return {
                                    ...player,
                                    originalTeam: index + 1,
                                    currentTeam: index + 1
                                };
                            }),
                            points: 0,
                            goals: 0,
                            goalsAgainst: 0,
                            matches: 0
                        };
                    });
                    
                    populateTeamSelects();
                    resetGameInterface();
                    setupGoalModal();
                    setupPlayerManagement();
                }

                function setupPlayerManagement() {
                    document.getElementById('addPlayerBtn').addEventListener('click', function() {
                        toggleAddPlayerSection();
                    });
                    
                    document.getElementById('swapPlayersBtn').addEventListener('click', function() {
                        openSwapModal();
                    });
                    
                    document.getElementById('confirmAddPlayer').addEventListener('click', function() {
                        addNewPlayer();
                    });
                    
                    document.getElementById('cancelAddPlayer').addEventListener('click', function() {
                        closeAddPlayerSection();
                    });
                    
                    document.getElementById('cancelSwapBtn').addEventListener('click', function() {
                        closeSwapModal();
                    });

                    document.getElementById('warningCancelBtn').addEventListener('click', function() {
                        closeTeamWarningModal();
                        // Manter modal de troca aberto para fazer ajustes
                    });

                    document.getElementById('warningContinueBtn').addEventListener('click', function() {
                        forceCloseSwapModal();
                    });

                    // Fechar modal se clicar fora
                    window.addEventListener('click', function(event) {
                        var warningModal = document.getElementById('teamWarningModal');
                        if (event.target === warningModal) {
                            closeTeamWarningModal();
                        }
                    });
                    
                    populateNewPlayerTeamSelect();
                }

                function toggleAddPlayerSection() {
                    var section = document.getElementById('addPlayerSection');
                    if (section.style.display === 'none') {
                        section.style.display = 'block';
                        document.getElementById('newPlayerName').focus();
                    } else {
                        closeAddPlayerSection();
                    }
                }

                function closeAddPlayerSection() {
                    document.getElementById('addPlayerSection').style.display = 'none';
                    document.getElementById('newPlayerName').value = '';
                    document.getElementById('newPlayerTeam').value = '';
                }

                function populateNewPlayerTeamSelect() {
                    var select = document.getElementById('newPlayerTeam');
                    select.innerHTML = '<option value="">Selecione o time</option>';
                    
                    gameData.teams.forEach(function(team) {
                        var option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }

                function addNewPlayer() {
                    var name = document.getElementById('newPlayerName').value.trim();
                    var teamId = parseInt(document.getElementById('newPlayerTeam').value);
                    
                    if (!name) {
                        showCustomAlert('Digite o nome do jogador!');
                        return;
                    }
                    
                    if (!teamId) {
                        showCustomAlert('Selecione um time!');
                        return;
                    }
                    
                    var team = gameData.teams.find(function(t) { return t.id === teamId; });
                    var newPlayer = {
                        name: name,
                        rating: 3,
                        isGoalkeeper: false,
                        isFake: false,
                        originalTeam: teamId,
                        currentTeam: teamId,
                        isNew: true
                    };
                    
                    team.players.push(newPlayer);
                    
                    if (gameData.currentMatch && (gameData.currentMatch.team1.id === teamId || gameData.currentMatch.team2.id === teamId)) {
                        populatePlayersList();
                    }
                    
                    closeAddPlayerSection();
                    showCustomAlert('Jogador ' + name + ' adicionado ao time ' + team.name + '!');
                }

                function openSwapModal() {
                    populateAllTeamsForSwap();
                    document.getElementById('playerSwapModal').style.display = 'block';
                }

                function populateAllTeamsForSwap() {
                    var teamsGrid = document.getElementById('swapTeamsGrid');
                    teamsGrid.innerHTML = '';
                    
                    gameData.teams.forEach(function(team) {
                        var teamSection = document.createElement('div');
                        teamSection.className = 'swap-team-section';
                        
                        var realPlayers = team.players.filter(function(p) { return !p.isFake; });
                        var playersCount = realPlayers.length;
                        var minPlayers = gameTypeSelect.value === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
                        
                        var countClass = playersCount < minPlayers ? 'warning-text' : '';
                        var countText = playersCount + ' jogador' + (playersCount !== 1 ? 'es' : '');
                        if (playersCount < minPlayers) {
                            countText += ' (M√≠n: ' + minPlayers + ')';
                        }
                        
                        teamSection.innerHTML = '<h5>' + team.name + '</h5>' +
                                            '<div class="team-players-count ' + countClass + '">' + countText + '</div>' +
                                            '<div id="team_' + team.id + '_players"></div>';
                        
                        var playersContainer = teamSection.querySelector('#team_' + team.id + '_players');
                        
                        realPlayers.forEach(function(player) {
                            var playerDiv = document.createElement('div');
                            playerDiv.className = 'swap-player-item';
                            
                            // Criar elemento do nome do jogador
                            var playerNameDiv = document.createElement('div');
                            playerNameDiv.innerHTML = '<strong>' + player.name + '</strong>';
                            playerDiv.appendChild(playerNameDiv);
                            
                            // Container para os bot√µes
                            var buttonsContainer = document.createElement('div');
                            buttonsContainer.style.marginTop = '5px';
                            
                            // Bot√£o de deletar (vermelho)
                            var deleteButton = document.createElement('button');
                            deleteButton.className = 'delete-player-btn';
                            deleteButton.textContent = 'üóëÔ∏è Deletar';
                            deleteButton.addEventListener('click', function() {
                                deletePlayerFromTeam(player.name, team.id, team.name);
                            });
                            buttonsContainer.appendChild(deleteButton);
                            
                            // Criar bot√µes para cada time de destino
                            gameData.teams.forEach(function(targetTeam) {
                                if (targetTeam.id !== team.id) {
                                    var moveButton = document.createElement('button');
                                    moveButton.className = 'move-player-btn';
                                    moveButton.style.margin = '2px';
                                    moveButton.style.fontSize = '10px';
                                    moveButton.textContent = '‚Üí ' + targetTeam.name;
                                    
                                    moveButton.addEventListener('click', function() {
                                        movePlayerToTeamFree(player.name, team.id, targetTeam.id, targetTeam.name);
                                    });
                                    
                                    buttonsContainer.appendChild(moveButton);
                                }
                            });
                            
                            playerDiv.appendChild(buttonsContainer);
                            playersContainer.appendChild(playerDiv);
                        });
                        
                        teamsGrid.appendChild(teamSection);
                    });
                }

                function deletePlayerFromTeam(playerName, teamId, teamName) {
                    // Confirma√ß√£o antes de deletar
                    var confirmDelete = confirm('ATEN√á√ÉO: Tem certeza que deseja DELETAR o jogador "' + playerName + '" do time "' + teamName + '"?\n\nEsta a√ß√£o n√£o pode ser desfeita!');
                    if (!confirmDelete) return;
                    
                    var team = gameData.teams.find(function(t) { return t.id === teamId; });
                    if (!team) return;
                    
                    // Encontrar e remover jogador do time
                    var playerIndex = team.players.findIndex(function(p) { return p.name === playerName; });
                    if (playerIndex === -1) return;
                    
                    // Remover do time global
                    team.players.splice(playerIndex, 1);
                    
                    // Se estiver em uma partida ativa, remover tamb√©m do currentMatch
                    if (gameData.currentMatch) {
                        var playerRemovedFromActiveTeam = false;
                        
                        // Remover do team1 se necess√°rio
                        if (gameData.currentMatch.team1.id === teamId) {
                            var matchPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                            if (matchPlayerIndex !== -1) {
                                gameData.currentMatch.team1.players.splice(matchPlayerIndex, 1);
                                playerRemovedFromActiveTeam = true;
                            }
                        }
                        
                        // Remover do team2 se necess√°rio
                        if (gameData.currentMatch.team2.id === teamId) {
                            var matchPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                            if (matchPlayerIndex !== -1) {
                                gameData.currentMatch.team2.players.splice(matchPlayerIndex, 1);
                                playerRemovedFromActiveTeam = true;
                            }
                        }
                        
                        // Atualizar interface da partida se necess√°rio
                        if (playerRemovedFromActiveTeam) {
                            populatePlayersList();
                        }
                    }
                    
                    // Atualizar modal
                    populateAllTeamsForSwap();
                    
                    showCustomAlert('Jogador ' + playerName + ' foi deletado do time ' + teamName);
                }

                function movePlayerToTeamFree(playerName, sourceTeamId, targetTeamId, targetTeamName) {
                    var sourceTeam = gameData.teams.find(function(t) { return t.id === sourceTeamId; });
                    var targetTeam = gameData.teams.find(function(t) { return t.id === targetTeamId; });
                    
                    if (!sourceTeam || !targetTeam) return;
                    
                    // Verificar se vai deixar o time de origem com poucos jogadores
                    var sourceRealPlayers = sourceTeam.players.filter(function(p) { return !p.isFake; });
                    var minPlayers = gameTypeSelect.value === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
                    
                    // Encontrar e remover jogador do time atual
                    var playerIndex = sourceTeam.players.findIndex(function(p) { return p.name === playerName; });
                    if (playerIndex === -1) return;
                    
                    var player = sourceTeam.players.splice(playerIndex, 1)[0];
                    player.currentTeam = targetTeam.id;
                    
                    // Adicionar ao novo time
                    targetTeam.players.push(player);
                    
                    // Se estiver em uma partida ativa, atualizar tamb√©m o currentMatch
                    if (gameData.currentMatch) {
                        var playerMovedToActiveTeam = false;
                        var playerRemovedFromActiveTeam = false;
                        
                        // REMOVER jogador dos times ativos se necess√°rio
                        if (gameData.currentMatch.team1.id === sourceTeamId) {
                            var matchPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                            if (matchPlayerIndex !== -1) {
                                gameData.currentMatch.team1.players.splice(matchPlayerIndex, 1);
                                playerRemovedFromActiveTeam = true;
                            }
                        }
                        
                        if (gameData.currentMatch.team2.id === sourceTeamId) {
                            var matchPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                            if (matchPlayerIndex !== -1) {
                                gameData.currentMatch.team2.players.splice(matchPlayerIndex, 1);
                                playerRemovedFromActiveTeam = true;
                            }
                        }
                        
                        // ADICIONAR jogador aos times ativos se necess√°rio
                        if (gameData.currentMatch.team1.id === targetTeamId) {
                            // Verificar se o jogador j√° n√£o est√° no time (evitar duplica√ß√£o)
                            var existingPlayerIndex = gameData.currentMatch.team1.players.findIndex(function(p) { return p.name === playerName; });
                            if (existingPlayerIndex === -1) {
                                gameData.currentMatch.team1.players.push(player);
                                playerMovedToActiveTeam = true;
                            }
                        }
                        
                        if (gameData.currentMatch.team2.id === targetTeamId) {
                            // Verificar se o jogador j√° n√£o est√° no time (evitar duplica√ß√£o)
                            var existingPlayerIndex = gameData.currentMatch.team2.players.findIndex(function(p) { return p.name === playerName; });
                            if (existingPlayerIndex === -1) {
                                gameData.currentMatch.team2.players.push(player);
                                playerMovedToActiveTeam = true;
                            }
                        }
                        
                        // Atualizar interface da partida se houve mudan√ßa nos times ativos
                        if (playerMovedToActiveTeam || playerRemovedFromActiveTeam) {
                            populatePlayersList();
                        }
                    }
                    
                    // Atualizar modal
                    populateAllTeamsForSwap();
                    if (gameData.currentMatch && 
                        (gameData.currentMatch.team1.id === sourceTeamId || gameData.currentMatch.team1.id === targetTeamId ||
                        gameData.currentMatch.team2.id === sourceTeamId || gameData.currentMatch.team2.id === targetTeamId)) {
                        
                        console.log('üîÑ Atualizando interface de jogo ap√≥s troca...');
                        populatePlayersList();
                    }
                }

                function closeSwapModal() {
                    // Verificar se h√° times com poucos jogadores antes de fechar
                    var teamsWithFewPlayers = [];
                    var minPlayers = gameTypeSelect.value === 'futsal' ? 5 : parseInt(document.getElementById('societyPlayers').value);
                    
                    gameData.teams.forEach(function(team) {
                        var realPlayers = team.players.filter(function(p) { return !p.isFake; });
                        if (realPlayers.length < minPlayers) {
                            teamsWithFewPlayers.push({
                                name: team.name,
                                playerCount: realPlayers.length,
                                minPlayers: minPlayers
                            });
                        }
                    });
                    
                    if (teamsWithFewPlayers.length > 0) {
                        showTeamWarningModal(teamsWithFewPlayers);
                    } else {
                        // Fechar normalmente se todos os times est√£o OK
                        document.getElementById('playerSwapModal').style.display = 'none';
                    }
                }

                function showTeamWarningModal(teamsWithFewPlayers) {
                    var warningModal = document.getElementById('teamWarningModal');
                    var teamsList = document.getElementById('warningTeamsList');
                    
                    teamsList.innerHTML = '';
                    
                    teamsWithFewPlayers.forEach(function(team) {
                        var teamItem = document.createElement('div');
                        teamItem.className = 'warning-team-item';
                        
                        teamItem.innerHTML = 
                            '<span class="warning-team-name">' + team.name + '</span>' +
                            '<span class="warning-team-count">' + team.playerCount + '/' + team.minPlayers + ' jogadores</span>';
                        
                        teamsList.appendChild(teamItem);
                    });
                    
                    warningModal.style.display = 'block';
                }

                function closeTeamWarningModal() {
                    document.getElementById('teamWarningModal').style.display = 'none';
                }

                function forceCloseSwapModal() {
                    document.getElementById('playerSwapModal').style.display = 'none';
                    closeTeamWarningModal();
                }
	
	            function setupGoalModal() {
	                document.getElementById('goalBtn').addEventListener('click', openGoalModal);
	                document.getElementById('goalModalCancel').addEventListener('click', closeGoalModal);
	                document.getElementById('goalModalConfirm').addEventListener('click', confirmGoal);
	                document.getElementById('ownGoalCheck').addEventListener('change', updateAssistOptions);
	            }
	
	            function openGoalModal() {
	                if (!gameData.currentMatch) return;
	                
	                var modal = document.getElementById('goalModal');
	                selectedGoalPlayer = null;
	                
	                document.getElementById('goalModalTeam1Name').textContent = gameData.currentMatch.team1.name;
	                document.getElementById('goalModalTeam2Name').textContent = gameData.currentMatch.team2.name;
	                
	                var team1Container = document.getElementById('goalModalTeam1Players');
	                team1Container.innerHTML = '';
	                var team1Players = gameData.currentMatch.team1.players.slice().sort(function(a, b) {
	                    return a.name.localeCompare(b.name);
	                });
	                
	                team1Players.forEach(function(player) {
	                    if (!player.isFake) {
	                        var playerDiv = document.createElement('div');
	                        playerDiv.className = 'goal-modal-player';
	                        playerDiv.textContent = player.name;
	                        playerDiv.onclick = function() { selectGoalPlayer(player, 1); };
	                        team1Container.appendChild(playerDiv);
	                    }
	                });
	                
	                var team2Container = document.getElementById('goalModalTeam2Players');
	                team2Container.innerHTML = '';
	                var team2Players = gameData.currentMatch.team2.players.slice().sort(function(a, b) {
	                    return a.name.localeCompare(b.name);
	                });
	                
	                team2Players.forEach(function(player) {
	                    if (!player.isFake) {
	                        var playerDiv = document.createElement('div');
	                        playerDiv.className = 'goal-modal-player';
	                        playerDiv.textContent = player.name;
	                        playerDiv.onclick = function() { selectGoalPlayer(player, 2); };
	                        team2Container.appendChild(playerDiv);
	                    }
	                });
	                
	                document.getElementById('ownGoalCheck').checked = false;
	                populateAssistSelect();
	                document.getElementById('goalModalConfirm').disabled = true;
	                
	                modal.style.display = 'block';
	            }
	
	            function selectGoalPlayer(player, team) {
                    // Adicionar sele√ß√£o atual
                    event.target.classList.add('selected');
                    selectedGoalPlayer = { player: player, team: team };
                    
                    // Habilitar bot√£o confirmar
                    document.getElementById('goalModalConfirm').disabled = false;
                    
                    // Popular assist√™ncias
                    var assistSelect = document.getElementById('assistSelect');
                    assistSelect.innerHTML = '<option value="">Nenhuma assist√™ncia</option>';
                    
                    // Determinar jogadores do mesmo time para assist√™ncia
                    var teamPlayers;
                    if (team === 1) {
                        teamPlayers = gameData.currentMatch.team1.players;
                    } else {
                        teamPlayers = gameData.currentMatch.team2.players;
                    }
                    
                    var eligiblePlayers = teamPlayers.filter(function(p) { 
                        return !p.isFake && p.name !== player.name; 
                    }).sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    
                    eligiblePlayers.forEach(function(p) {
                        var option = document.createElement('option');
                        option.value = p.name;
                        option.textContent = p.name;
                        assistSelect.appendChild(option);
                    });
                }
	
	            function populateAssistSelect() {
                    var assistSelect = document.getElementById('assistSelect');
                    assistSelect.innerHTML = '<option value="">Nenhuma assist√™ncia</option>';
                    
                    if (!gameData.currentMatch || !selectedGoalPlayer) return;
                    
                    // Determinar time do jogador que fez o gol
                    var goalPlayerTeam = selectedGoalPlayer.team;
                    var teamPlayers;
                    
                    if (goalPlayerTeam === 1) {
                        teamPlayers = gameData.currentMatch.team1.players;
                    } else {
                        teamPlayers = gameData.currentMatch.team2.players;
                    }
                    
                    // Apenas jogadores do mesmo time, exceto quem fez o gol
                    var eligiblePlayers = teamPlayers.filter(function(p) { 
                        return !p.isFake && p.name !== selectedGoalPlayer.player.name; 
                    }).sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    
                    eligiblePlayers.forEach(function(player) {
                        var option = document.createElement('option');
                        option.value = player.name;
                        option.textContent = player.name;
                        assistSelect.appendChild(option);
                    });
                }

	            function updateAssistOptions() {
	                populateAssistSelect();
	            }
	
	            function closeGoalModal() {
	                document.getElementById('goalModal').style.display = 'none';
	                selectedGoalPlayer = null;
	            }
	
	            function confirmGoal() {
	                if (!selectedGoalPlayer) return;
	                
	                var isOwnGoal = document.getElementById('ownGoalCheck').checked;
	                var assistPlayer = document.getElementById('assistSelect').value;
	                
	                var goalData = {
	                    player: selectedGoalPlayer.player,
	                    team: selectedGoalPlayer.team,
	                    isOwnGoal: isOwnGoal,
	                    assist: assistPlayer || null,
                    time: gameData.timer.minutes + ':' + String(gameData.timer.seconds).padStart(2, '0')
                };
                
                addGoalFromModal(goalData);
                closeGoalModal();
            }

            function addGoalFromModal(goalData) {
                var match = gameData.currentMatch;
                
                var goalPlayerTeamName = goalData.team === 1 ? match.team1.name : match.team2.name;
                
                var goal = {
                    player: goalData.player.name,
                    playerTeam: goalPlayerTeamName,
                    type: goalData.isOwnGoal ? 'own' : 'normal',
                    time: goalData.time,
                    team: goalData.team,
                    assist: goalData.assist
                };
                
                if (!match.goals) match.goals = [];
                match.goals.push(goal);
                
                // Atualizar placar
                if (goalData.isOwnGoal) {
                    if (goalData.team === 1) {
                        match.score2++;
                    } else {
                        match.score1++;
                    }
                } else {
                    if (goalData.team === 1) {
                        match.score1++;
                    } else {
                        match.score2++;
                    }
                }
                
                // Atualizar interface
                document.getElementById('team1Score').textContent = match.score1;
                document.getElementById('team2Score').textContent = match.score2;
                
                // Atualizar contador de gols do jogador
                var playerGoalSpan = document.getElementById('goals-' + goalData.player.name.replace(/\s+/g, ''));
                if (playerGoalSpan && !goalData.isOwnGoal) {
                    var currentGoals = parseInt(playerGoalSpan.textContent) || 0;
                    playerGoalSpan.textContent = currentGoals + 1;
                }
                
                // Atualizar hist√≥rico
                var goalsList = document.getElementById('goalsList');
                if (goalsList) {
                    var goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-item';
                    
                    var goalText = goal.time + ' - ' + goal.player + ' (' + goal.playerTeam + ')';
                    if (goal.type === 'own') {
                        goalText += ' (Gol Contra)';
                    }
                    if (goal.assist) {
                        goalText += ' (Assist: ' + goal.assist + ')';
                    }
                    
                    goalDiv.textContent = goalText;
                    goalsList.appendChild(goalDiv);
                }
                
                console.log('‚öΩ Gol adicionado:', goal);
            }
            
            function populateTeamSelects() {
                var team1Select = document.getElementById('team1Select');
                var team2Select = document.getElementById('team2Select');
                
                team1Select.innerHTML = '';
                team2Select.innerHTML = '';
                
                gameData.teams.forEach(function(team) {
                    var option1 = document.createElement('option');
                    option1.value = team.id;
                    option1.textContent = team.name;
                    team1Select.appendChild(option1);
                    
                    var option2 = document.createElement('option');
                    option2.value = team.id;
                    option2.textContent = team.name;
                    team2Select.appendChild(option2);
                });
                
                if (gameData.teams.length > 1) {
                    team2Select.value = gameData.teams[1].id;
                }
            }
            
            function resetGameInterface() {
                document.getElementById('gameConfigSection').style.display = 'block';
                document.getElementById('playerManagementSection').style.display = 'none';
                document.getElementById('gamePlaySection').style.display = 'none';
                document.getElementById('gameResultSection').style.display = 'none';
                document.getElementById('gameBackBtn').style.display = 'none';
                
                resetTimer();
                
                document.getElementById('team1Score').textContent = '0';
                document.getElementById('team2Score').textContent = '0';
                document.getElementById('goalsList').innerHTML = '';
            }
	            
	            document.getElementById('gameMode').addEventListener('change', function() {
	                var timedOptions = document.getElementById('timedGameOptions');
	                if (this.value === 'timed') {
	                    timedOptions.style.display = 'block';
	                } else {
	                    timedOptions.style.display = 'none';
	                }
	            });
	            
	            document.getElementById('startMatch').addEventListener('click', function() {
	                var team1Id = parseInt(document.getElementById('team1Select').value);
	                var team2Id = parseInt(document.getElementById('team2Select').value);
	                
	                if (team1Id === team2Id) {
	                    showCustomAlert('Selecione times diferentes para a partida!');
	                    return;
	                }
	                
	                startMatch(team1Id, team2Id);
	            });
	            
	            function startMatch(team1Id, team2Id) {
	                var team1 = gameData.teams.find(function(t) { return t.id === team1Id; });
	                var team2 = gameData.teams.find(function(t) { return t.id === team2Id; });
	                
	                gameData.gameMode = document.getElementById('gameMode').value;
	                gameData.timeLimit = parseInt(document.getElementById('gameTime').value);
	                gameData.goalLimit = parseInt(document.getElementById('goalLimit').value);
	                
	                gameData.currentMatch = {
	                    team1: team1,
	                    team2: team2,
	                    score1: 0,
	                    score2: 0,
	                    goals: [],
	                    startTime: new Date(),
	                    endTime: null,
	                    winner: null
	                };
	                
	                setupMatchInterface();
	                
	                document.getElementById('gameConfigSection').style.display = 'none';
	                document.getElementById('gamePlaySection').style.display = 'block';
	                document.getElementById('gameBackBtn').style.display = 'block';
                    if (currentUser) saveCurrentGameState();
	            }
	            
	            function setupMatchInterface() {
                    var match = gameData.currentMatch;
                    
                    document.getElementById('matchTitle').textContent = match.team1.name + ' vs ' + match.team2.name;
                    document.getElementById('team1Name').textContent = match.team1.name;
                    document.getElementById('team2Name').textContent = match.team2.name;
                    document.getElementById('team1PanelName').textContent = match.team1.name;
                    document.getElementById('team2PanelName').textContent = match.team2.name;
                    
                    var gameTypeInfo = document.getElementById('gameTypeInfo');
                    if (gameData.gameMode === 'timed') {
                        gameTypeInfo.textContent = 'Primeiro a ' + gameData.goalLimit + ' gols ou ' + gameData.timeLimit + ' minutos';
                    } else {
                        gameTypeInfo.textContent = 'Jogo cont√≠nuo - sem limite de tempo';
                    }
                    
                    populatePlayersList();
                    if (currentUser) saveCurrentGameState();
                    resetTimer();
                    
                    // Mostrar se√ß√£o de gerenciamento
                    document.getElementById('playerManagementSection').style.display = 'block';
                }
	            
	            function populatePlayersList() {
                    var team1Players = document.getElementById('team1Players');
                    var team2Players = document.getElementById('team2Players');
                    
                    team1Players.innerHTML = '';
                    team2Players.innerHTML = '';
                    
                    // BUSCAR DADOS ATUALIZADOS dos times globais em vez do currentMatch
                    var team1Data = gameData.teams.find(function(t) { 
                        return t.id === gameData.currentMatch.team1.id; 
                    });
                    var team2Data = gameData.teams.find(function(t) { 
                        return t.id === gameData.currentMatch.team2.id; 
                    });
                    
                    // Usar dados globais atualizados em vez dos dados do currentMatch
                    var team1PlayersData = team1Data ? team1Data.players : gameData.currentMatch.team1.players;
                    var team2PlayersData = team2Data ? team2Data.players : gameData.currentMatch.team2.players;
                    
                    team1PlayersData.forEach(function(player) {
                        if (!player.isFake) {
                            var playerDiv = document.createElement('div');
                            playerDiv.className = 'player-item-game';
                            playerDiv.innerHTML = '<span>' + player.name + '</span><span class="player-goals" id="goals-' + player.name.replace(/\s+/g, '') + '">0</span>';
                            team1Players.appendChild(playerDiv);
                        }
                    });
                    
                    team2PlayersData.forEach(function(player) {
                        if (!player.isFake) {
                            var playerDiv = document.createElement('div');
                            playerDiv.className = 'player-item-game';
                            playerDiv.innerHTML = '<span>' + player.name + '</span><span class="player-goals" id="goals-' + player.name.replace(/\s+/g, '') + '">0</span>';
                            team2Players.appendChild(playerDiv);
                        }
                    });
                    
                    // SINCRONIZAR currentMatch com dados globais atualizados
                    gameData.currentMatch.team1.players = team1PlayersData;
                    gameData.currentMatch.team2.players = team2PlayersData;
                }
                
                function resetTimer() {
	                gameData.timer.minutes = 0;
	                gameData.timer.seconds = 0;
	                gameData.timer.running = false;
	                
	                if (gameData.timer.interval) {
	                    clearInterval(gameData.timer.interval);
	                    gameData.timer.interval = null;
	                }
                
                updateTimerDisplay();
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Iniciar';
            }
            
            function updateTimerDisplay() {
                var minutes = String(gameData.timer.minutes).padStart(2, '0');
                var seconds = String(gameData.timer.seconds).padStart(2, '0');
                document.getElementById('timer').textContent = minutes + ':' + seconds;
            }
	            
            function startTimer() {
                if (gameData.timer.running) return;
                
                gameData.timer.running = true;
                document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è Pausar';
                
                gameData.timer.interval = setInterval(function() {
                    gameData.timer.seconds++;
                    
                    if (gameData.timer.seconds >= 60) {
                        gameData.timer.seconds = 0;
                        gameData.timer.minutes++;
                    }
                    
                    updateTimerDisplay();
                    
                    if (gameData.gameMode === 'timed' && gameData.timer.minutes >= gameData.timeLimit) {
                        endMatch('time');
                    }
                }, 1000);
            }
            
            function pauseTimer() {
                if (!gameData.timer.running) return;
                
                gameData.timer.running = false;
                document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Continuar';
                
                if (gameData.timer.interval) {
                    clearInterval(gameData.timer.interval);
                    gameData.timer.interval = null;
                }
            }
            
            document.getElementById('playPauseBtn').addEventListener('click', function() {
                if (gameData.timer.running) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });
            
            document.getElementById('endGameBtn').addEventListener('click', function() {
                endMatch('manual');
            });
            
            function updateScoreboard() {
                var match = gameData.currentMatch;
                document.getElementById('team1Score').textContent = match.score1;
                document.getElementById('team2Score').textContent = match.score2;
            }
            
            function updateGoalHistory() {
                var goalsList = document.getElementById('goalsList');
                var match = gameData.currentMatch;
                
                goalsList.innerHTML = '';
                
                match.goals.forEach(function(goal) {
                    var goalDiv = document.createElement('div');
                    goalDiv.className = 'goal-item';
                    
                    var goalText = goal.time + ' - ' + goal.player + ' (' + goal.playerTeam + ')';
                    if (goal.type === 'own') {
                        goalText += ' (Gol Contra)';
                    }
                    if (goal.assist) {
                        goalText += ' (Assist: ' + goal.assist + ')';
                    }
                    
                    goalDiv.textContent = goalText;
                    goalsList.appendChild(goalDiv);
                });
            }
            
            function updatePlayerGoals(playerName) {
                var playerGoalSpan = document.getElementById('goals-' + playerName.replace(/\s+/g, ''));
                if (playerGoalSpan) {
                    var currentGoals = parseInt(playerGoalSpan.textContent) || 0;
                    playerGoalSpan.textContent = currentGoals + 1;
                }
            }
            
            function endMatch(reason) {
                pauseTimer();
                
                var match = gameData.currentMatch;
                match.endTime = new Date();
                
                var winner = null;
                var points1 = 0, points2 = 0;
                
                if (match.score1 > match.score2) {
                    winner = match.team1;
                    points1 = 3;
                    points2 = 0;
                } else if (match.score2 > match.score1) {
                    winner = match.team2;
                    points1 = 0;
                    points2 = 3;
                } else {
                    points1 = 1;
                    points2 = 1;
                }
                
                match.winner = winner;
                
                match.team1.points += points1;
                match.team2.points += points2;
                match.team1.goals += match.score1;
                match.team2.goals += match.score2;
                match.team1.goalsAgainst += match.score2;
                match.team2.goalsAgainst += match.score1;
                match.team1.matches++;
                match.team2.matches++;
                
                updateTournamentStats();
                gameData.matches.push(match);
                
                showMatchResult(reason);
                
                // Save complete match to history
                if (currentUser) {
                    var duration = gameData.timer.minutes + ':' + String(gameData.timer.seconds).padStart(2, '0');
                    var gameResult = {
                        teams: match.team1.name + ' vs ' + match.team2.name,
                        description: 'Partida individual finalizada',
                        finalScore: match.score1 + ' x ' + match.score2,
                        duration: duration,
                        winner: winner ? winner.name : 'Empate',
                        reason: reason,
                        goals: match.goals,
                        players: {
                            team1: match.team1.players.map(p => p.name),
                            team2: match.team2.players.map(p => p.name)
                        }
                    };
                    saveGameToHistory(gameResult);
                }
            }
            
            function updateTournamentStats() {
                var match = gameData.currentMatch;
                
                if (!gameData.tournamentStats.playerGoals) {
                    gameData.tournamentStats.playerGoals = {};
                }
                if (!gameData.tournamentStats.playerOwnGoals) {
                    gameData.tournamentStats.playerOwnGoals = {};
                }
                if (!gameData.tournamentStats.playerAssists) {
                    gameData.tournamentStats.playerAssists = {};
                }
                
                match.goals.forEach(function(goal) {
                    // Separar gols normais de gols contra
                    if (goal.type === 'own') {
                        // Gol contra - n√£o conta na artilharia
                        if (!gameData.tournamentStats.playerOwnGoals[goal.player]) {
                            gameData.tournamentStats.playerOwnGoals[goal.player] = 0;
                        }
                        gameData.tournamentStats.playerOwnGoals[goal.player]++;
                    } else {
                        // Gol normal - conta na artilharia
                        if (!gameData.tournamentStats.playerGoals[goal.player]) {
                            gameData.tournamentStats.playerGoals[goal.player] = 0;
                        }
                        gameData.tournamentStats.playerGoals[goal.player]++;
                    }
                    
                    // Assist√™ncias (s√≥ para gols normais)
                    if (goal.assist && goal.type !== 'own') {
                        if (!gameData.tournamentStats.playerAssists[goal.assist]) {
                            gameData.tournamentStats.playerAssists[goal.assist] = 0;
                        }
                        gameData.tournamentStats.playerAssists[goal.assist]++;
                    }
                });
            }
            
            function showMatchResult(reason) {
                var match = gameData.currentMatch;
                
                document.getElementById('gamePlaySection').style.display = 'none';
                document.getElementById('gameResultSection').style.display = 'block';
                
                var finalScore = document.getElementById('finalScore');
                finalScore.textContent = match.team1.name + ' ' + match.score1 + ' x ' + match.score2 + ' ' + match.team2.name;
                
                var finalResult = document.getElementById('finalResult');
                if (match.winner) {
                    finalResult.textContent = 'üèÜ Vencedor: ' + match.winner.name + '!';
                    finalResult.style.color = '#28a745';
                } else {
                    finalResult.textContent = 'ü§ù Empate!';
                    finalResult.style.color = '#ffc107';
                }
                
                var matchSummary = document.getElementById('matchSummary');
                var duration = gameData.timer.minutes + ':' + String(gameData.timer.seconds).padStart(2, '0');
                
                var summary = '<h5>üìä Resumo da Partida</h5>';
                summary += '<p><strong>Dura√ß√£o:</strong> ' + duration + '</p>';
                summary += '<p><strong>Raz√£o do fim:</strong> ';
                
                if (reason === 'time') {
                    summary += 'Tempo esgotado</p>';
                } else if (reason === 'goals') {
                    summary += 'Limite de gols atingido</p>';
                } else {
                    summary += 'Finalizada manualmente</p>';
                }
                
                summary += '<p><strong>Pontos atribu√≠dos:</strong></p>';
                summary += '<ul>';
                summary += '<li>' + match.team1.name + ': ' + (match.score1 > match.score2 ? 3 : match.score1 === match.score2 ? 1 : 0) + ' pontos</li>';
                summary += '<li>' + match.team2.name + ': ' + (match.score2 > match.score1 ? 3 : match.score1 === match.score2 ? 1 : 0) + ' pontos</li>';
                summary += '</ul>';
                
                if (match.goals.length > 0) {
                    summary += '<p><strong>Gols marcados:</strong></p>';
                    summary += '<ul>';
                    match.goals.forEach(function(goal) {
                        summary += '<li>' + goal.time + ' - ' + goal.player + ' (' + goal.playerTeam + ')';
                        if (goal.type === 'own') summary += ' (Gol Contra)';
                        if (goal.assist) summary += ' (Assist: ' + goal.assist + ')';
                        summary += '</li>';
                    });
                    summary += '</ul>';
                }
                
	                matchSummary.innerHTML = summary;
	            }
	            
	            document.getElementById('nextMatchBtn').addEventListener('click', function() {
	                resetGameInterface();
	            });
	            
	            document.getElementById('finishTournamentBtn').addEventListener('click', function() {
	                generateTournamentReport();
	            });
	            
	            function generateTournamentReport() {
                    console.log('üèÜ Gerando relat√≥rio do torneio...');
                    
                    var report = 'üèÜ RELAT√ìRIO DO TORNEIO üèÜ\n\n';
                    
                    var sortedTeams = gameData.teams.slice().sort(function(a, b) {
                        if (b.points !== a.points) return b.points - a.points;
                        var saldoA = a.goals - a.goalsAgainst;
                        var saldoB = b.goals - b.goalsAgainst;
                        if (saldoB !== saldoA) return saldoB - saldoA;
                        return b.goals - a.goals;
                    });
                    
                    report += 'üìä CLASSIFICA√á√ÉO FINAL:\n';
                    sortedTeams.forEach(function(team, index) {
                        var saldo = team.goals - team.goalsAgainst;
                        report += (index + 1) + '¬∫ ' + team.name + ' - ' + team.points + ' pts';
                        report += ' (J:' + team.matches + ' SG:' + saldo + ')\n';
                    });
                    
                    if (gameData.tournamentStats.playerGoals) {
                        var topScorers = Object.keys(gameData.tournamentStats.playerGoals)
                            .map(function(player) {
                                return { 
                                    name: player, 
                                    goals: gameData.tournamentStats.playerGoals[player] 
                                };
                            })
                            .sort(function(a, b) { return b.goals - a.goals; });
                        
                        report += '\n‚öΩ ARTILHEIROS:\n';
                        topScorers.forEach(function(scorer, index) {
                            report += (index + 1) + '¬∫ ' + scorer.name + ' - ' + scorer.goals + ' gol';
                            if (scorer.goals !== 1) report += 's';
                            
                            // Verificar se o jogador tamb√©m tem gols contra
                            var ownGoals = gameData.tournamentStats.playerOwnGoals[scorer.name] || 0;
                            if (ownGoals > 0) {
                                report += ' (e ' + ownGoals + ' contra)';
                            }
                            
                            report += '\n';
                        });
                    }

                    if (gameData.tournamentStats.playerOwnGoals) {
                        var playersOnlyOwnGoals = Object.keys(gameData.tournamentStats.playerOwnGoals)
                            .filter(function(player) {
                                return !gameData.tournamentStats.playerGoals[player]; // S√≥ gols contra, nenhum gol normal
                            })
                            .map(function(player) {
                                return {
                                    name: player,
                                    ownGoals: gameData.tournamentStats.playerOwnGoals[player]
                                };
                            })
                            .sort(function(a, b) { return b.ownGoals - a.ownGoals; });
                        
                        if (playersOnlyOwnGoals.length > 0) {
                            report += '\nüö´ GOLS CONTRA:\n';
                            playersOnlyOwnGoals.forEach(function(player, index) {
                                report += (index + 1) + '¬∫ ' + player.name + ' - ' + player.ownGoals + ' gol';
                                if (player.ownGoals !== 1) report += 's';
                                report += ' contra\n';
                            });
                        }
                    }
                    
                    if (gameData.tournamentStats.playerAssists) {
                        var topAssisters = Object.keys(gameData.tournamentStats.playerAssists)
                            .map(function(player) {
                                return { 
                                    name: player, 
                                    assists: gameData.tournamentStats.playerAssists[player] 
                                };
                            })
                            .sort(function(a, b) { return b.assists - a.assists; });
                        
                        if (topAssisters.length > 0) {
                            report += '\nüÖ∞Ô∏è ASSIST√äNCIAS:\n';
                            topAssisters.forEach(function(assister, index) {
                                report += (index + 1) + '¬∫ ' + assister.name + ' - ' + assister.assists + ' assist';
                                if (assister.assists !== 1) report += 's';
                                report += '\n';
                            });
                        }
                    }
                    
                    if (gameData.matches.length > 0) {
                        report += '\nüìã HIST√ìRICO DE JOGOS:\n';
                        gameData.matches.forEach(function(match, index) {
                            report += (index + 1) + '. ' + match.team1.name + ' ' + match.score1;
                            report += ' x ' + match.score2 + ' ' + match.team2.name;
                            if (match.winner) {
                                report += ' (Venceu: ' + match.winner.name + ')';
                            } else {
                                report += ' (Empate)';
                            }
                            report += '\n';
                            
                            // Adicionar gols se houver
                            if (match.goals && match.goals.length > 0) {
                                match.goals.forEach(function(goal) {
                                    report += '  ‚öΩ ' + goal.time + ' - ' + goal.player + ' (' + goal.playerTeam + ')';
                                    if (goal.type === 'own') report += ' (Gol Contra)';
                                    if (goal.assist) report += ' (Assist: ' + goal.assist + ')';
                                    report += '\n';
                                });
                            }
                            report += '\n';
                        });
                    }
                    
                    report += '\nüé≤ Sorteio gerado pelo sistema autom√°tico';
                    
                    // SALVAR NO HIST√ìRICO PRIMEIRO
                    if (currentUser) {
                        const completeGameResult = {
                            teams: gameData.teams.map(t => t.name).join(' vs '),
                            description: 'Torneio completo finalizado',
                            finalScore: gameData.matches.length > 0 ? 
                                `${gameData.matches.length} partidas realizadas` : 
                                'Torneio completo',
                            duration: 'M√∫ltiplas partidas',
                            tournamentStats: gameData.tournamentStats,
                            matches: gameData.matches,
                            teamsData: gameData.teams.map(team => ({
                                name: team.name,
                                points: team.points,
                                goals: team.goals,
                                goalsAgainst: team.goalsAgainst,
                                matches: team.matches,
                                players: team.players.map(p => p.name)
                            })),
                            gameConfig: {
                                gameType: document.getElementById('gameType').value,
                                numTeams: gameData.teams.length,
                                totalPlayers: gameData.teams.reduce((total, team) => 
                                    total + team.players.filter(p => !p.isFake).length, 0)
                            }
                        };
                        
                        saveGameToHistory(completeGameResult);
                        console.log('üíæ Torneio completo salvo no hist√≥rico!');
                    }
                    
                    // PERGUNTAR SE QUER ENVIAR PARA O WHATSAPP
                    var sendToWhatsApp = confirm(
                        'üèÜ TORNEIO FINALIZADO!\n\n' +
                        'O relat√≥rio completo foi gerado e salvo no seu hist√≥rico.\n\n' +
                        'üì± Deseja enviar o relat√≥rio pelo WhatsApp?'
                    );
                    
                    if (sendToWhatsApp) {
                        console.log('üì± Usu√°rio optou por enviar para WhatsApp');
                        
                        // Enviar para WhatsApp
                        var encodedMessage = encodeURIComponent(report);
                        var whatsappUrl = 'https://api.whatsapp.com/send?text=' + encodedMessage;
                        window.open(whatsappUrl, '_blank');
                        
                        // Aguardar um pouco e ent√£o resetar
                        setTimeout(function() {
                            resetToInitialState();
                        }, 2000);
                        
                    } else {
                        console.log('‚ùå Usu√°rio optou por n√£o enviar para WhatsApp');
                        
                        // Mostrar relat√≥rio em alert e resetar
                        alert(
                            '‚úÖ TORNEIO FINALIZADO!\n\n' +
                            'O relat√≥rio completo foi salvo no seu hist√≥rico.\n\n' +
                            'Voc√™ pode acess√°-lo a qualquer momento atrav√©s do bot√£o "Mostrar Hist√≥rico".'
                        );
                        
                        // Resetar imediatamente
                        resetToInitialState();
                    }
                }

                function resetToInitialState() {
                    console.log('üîÑ Resetando para estado inicial...');
                    
                    // Limpar dados do jogo
                    playersInput.value = '';
                    if (typeof updatePlayerCounter === 'function') {
                        updatePlayerCounter();
                    }
                    currentTeams = [];
                    teamNames = [];
                    savedRatings = {};
                    gameData = {
                        teams: [],
                        matches: [],
                        currentMatch: null,
                        timer: { minutes: 0, seconds: 0, interval: null, running: false },
                        gameMode: 'continuous',
                        timeLimit: 10,
                        goalLimit: 2,
                        tournamentStats: {}
                    };
                    
                    // Voltar para step 1
                    var steps = document.querySelectorAll('.step');
                    var stepDots = document.querySelectorAll('.step-dot');
                    
                    for (var i = 0; i < steps.length; i++) {
                        steps[i].classList.remove('active');
                    }
                    for (var i = 0; i < stepDots.length; i++) {
                        stepDots[i].classList.remove('active');
                    }
                    
                    var step1Element = document.getElementById('step1');
                    var dot1Element = document.querySelector('.step-dot[data-step="1"]');
                    
                    if (step1Element) step1Element.classList.add('active');
                    if (dot1Element) dot1Element.classList.add('active');
                    
                    console.log('‚úÖ Estado inicial restaurado - pronto para novo sorteio!');
                }
                
                window.movePlayerToTeamFree = movePlayerToTeamFree;
                window.deletePlayerFromTeam = deletePlayerFromTeam;
                window.showTeamWarningModal = showTeamWarningModal;
                window.closeTeamWarningModal = closeTeamWarningModal;
                window.forceCloseSwapModal = forceCloseSwapModal;

                // Bot√£o para ver uso do Firebase
                document.getElementById('verUsoFirebase').addEventListener('click', function() {
                    contadorFirebase.verRelatorio();
                });
            });
            
            // =========== DEBUG DOS BOT√ïES - ADICIONAR NO FINAL DO SCRIPT ===========
            console.log('üîç INICIANDO DEBUG DOS BOT√ïES...');

            // 1. Verificar se os elementos existem
            setTimeout(function() {
                console.log('üîç Verificando elementos...');
                
                const showRegister = document.getElementById('showRegister');
                const showLogin = document.getElementById('showLogin');
                const showForgotPassword = document.getElementById('showForgotPassword');
                const backToLogin = document.getElementById('backToLogin');
                
                console.log('showRegister encontrado:', !!showRegister);
                console.log('showLogin encontrado:', !!showLogin);
                console.log('showForgotPassword encontrado:', !!showForgotPassword);
                console.log('backToLogin encontrado:', !!backToLogin);
                
                // 2. Verificar se a fun√ß√£o showAuthForm existe
                console.log('Fun√ß√£o showAuthForm existe:', typeof showAuthForm);
                
                // 3. Adicionar event listeners com debug
                if (showRegister) {
                    showRegister.addEventListener('click', function(e) {
                        console.log('üü¢ CLIQUE EM showRegister DETECTADO!');
                        e.preventDefault();
                        console.log('üîÑ Chamando showAuthForm("register")...');
                        if (typeof showAuthForm === 'function') {
                            showAuthForm('register');
                            console.log('‚úÖ showAuthForm("register") executado');
                        } else {
                            console.error('‚ùå showAuthForm n√£o √© uma fun√ß√£o!');
                        }
                    });
                    console.log('‚úÖ Event listener adicionado ao showRegister');
                } else {
                    console.error('‚ùå Elemento showRegister n√£o encontrado!');
                }
                
                if (showLogin) {
                    showLogin.addEventListener('click', function(e) {
                        console.log('üü¢ CLIQUE EM showLogin DETECTADO!');
                        e.preventDefault();
                        showAuthForm('login');
                    });
                    console.log('‚úÖ Event listener adicionado ao showLogin');
                }
                
                if (showForgotPassword) {
                    showForgotPassword.addEventListener('click', function(e) {
                        console.log('üü¢ CLIQUE EM showForgotPassword DETECTADO!');
                        e.preventDefault();
                        showAuthForm('forgot');
                    });
                    console.log('‚úÖ Event listener adicionado ao showForgotPassword');
                }
                
                if (backToLogin) {
                    backToLogin.addEventListener('click', function(e) {
                        console.log('üü¢ CLIQUE EM backToLogin DETECTADO!');
                        e.preventDefault();
                        showAuthForm('login');
                    });
                    console.log('‚úÖ Event listener adicionado ao backToLogin');
                }
                
            }, 1000); // Aguardar 1 segundo para garantir que tudo carregou

            // 4. Teste manual da fun√ß√£o
            window.testarShowAuthForm = function() {
                console.log('üß™ TESTE MANUAL - Chamando showAuthForm("register")...');
                if (typeof showAuthForm === 'function') {
                    showAuthForm('register');
                    console.log('‚úÖ Fun√ß√£o executou com sucesso!');
                } else {
                    console.error('‚ùå showAuthForm n√£o existe!');
                }
            };

            console.log('üéØ DEBUG INSTALADO! Digite no console: testarShowAuthForm()');
            // =========== FIM DO DEBUG ===========
        </script>
</body>
</html>
